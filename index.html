<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Major Metals CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mobile-specific optimizations */
        @media (max-width: 1024px) {
            button, a, input, select, textarea {
                min-height: 44px;
            }
            
            * {
                -webkit-overflow-scrolling: touch;
            }
            
            .safe-top {
                padding-top: env(safe-area-inset-top);
            }
            
            .safe-bottom {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            button, nav {
                -webkit-user-select: none;
                user-select: none;
            }
            
            input, select, textarea {
                font-size: 16px;
            }
            
            .overflow-x-auto::-webkit-scrollbar {
                height: 6px;
            }
            
            .overflow-x-auto::-webkit-scrollbar-track {
                background: #f1f1f1;
            }
            
            .overflow-x-auto::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 3px;
            }
        }
        
        @supports (height: 100dvh) {
            .min-h-screen {
                min-height: 100dvh;
            }
        }

        /* Form sections styling */
        .form-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .form-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #374151;
        }

        /* Character counter styling */
        .char-counter {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
            margin-top: 0.25rem;
        }

        /* URL input validation */
        input[type="url"]:invalid {
            border-color: #ef4444;
        }

        input[type="url"]:valid {
            border-color: #10b981;
        }

        /* Drag and drop styles */
        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            background-color: #dbeafe;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Firebase configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCKIKzPH6ibixe7rnq0em4AAsdq5b10WDA",
            authDomain: "crm-mm-7bdfb.firebaseapp.com",
            databaseURL: "https://crm-mm-7bdfb-default-rtdb.firebaseio.com",
            projectId: "crm-mm-7bdfb",
            storageBucket: "crm-mm-7bdfb.firebasestorage.app",
            messagingSenderId: "321138365753",
            appId: "1:321138365753:web:866da9cdc5a300219944e8"
        };

        // Industries list
        const INDUSTRIES = [
            "Access Flooring", "Agriculture", "Association / Trade Group", "Automotive", 
            "Basement Columns", "Carport / Metal Buildings", "Carports", "Chair Lifts", 
            "Containers (IBC)", "Conveyor", "DOT Manufacturing", "Defense Contractor", 
            "Distributor", "Engineered Cabs", "Equipment", "Fabric Structures / Hoop Buildings", 
            "Fabrication", "Fans & Fans Racks Manufacturing", "Fencing", "Fitness Equipment", 
            "Furniture", "Highway", "Highway, Rail", "ISO Intermodal Containers", "Ladder", 
            "Lawn & Garden", "Manufacturer", "Metal Buildings", "Metal Buildings / Carports", 
            "Metal Stamping", "Mezzanines", "Mobile Housing", "RV", "Racking - Automotive", 
            "Racking - Computer Servers", "Racking - Servers", "Racking / Storage", "Racks", 
            "Roll Former", "Roll Off / Dumpster", "Rollforming", "Scaffolding", "Service center", 
            "Signpost", "Solar", "Steel buildings", "Storage / Racking", 
            "Structural Steel Fabrication", "Tension Fabric Buildings", "Tire Racks", 
            "Trailers", "Truck Equipment", "Tubular Wire Carriers", "Other"
        ];

        // Main CRM Application Class
        class MajorMetalsCRM {
            constructor() {
                this.state = {
                    activeView: 'dashboard',
                    customers: [],
                    opportunities: [],
                    quotes: [],
                    activities: [],
                    showModal: null,
                    formData: {},
                    searchTerm: '',
                    activityFilter: 'all',
                    industryFilter: 'all',
                    showFollowUp: null,
                    isOnline: navigator.onLine,
                    isSyncing: false,
                    lastSync: null,
                    firebaseDb: null,
                    isFirebaseConfigured: false,
                    editingCustomer: null,
                    mobileMenuOpen: false,
                    selectedOpp: null
                };

                this.customerStages = [
                    { id: 'lead', name: 'Lead', color: 'bg-gray-500' },
                    { id: 'qualified', name: 'Qualified', color: 'bg-blue-500' },
                    { id: 'quote_out', name: 'Quote Out', color: 'bg-purple-500' },
                    { id: 'negotiating', name: 'Negotiating', color: 'bg-yellow-500' },
                    { id: 'po_pending', name: 'PO Pending', color: 'bg-orange-500' },
                    { id: 'po_received', name: 'PO Received', color: 'bg-green-500' },
                    { id: 'fulfillment', name: 'In Fulfillment', color: 'bg-indigo-500' },
                    { id: 'delivered', name: 'Delivered', color: 'bg-teal-500' }
                ];

                this.pipelineStages = [
                    { id: 'new', name: 'New Lead', color: 'bg-gray-500' },
                    { id: 'qualified', name: 'Qualified', color: 'bg-blue-500' },
                    { id: 'quoted', name: 'Quoted', color: 'bg-purple-500' },
                    { id: 'negotiation', name: 'Negotiation', color: 'bg-yellow-500' },
                    { id: 'won', name: 'Won', color: 'bg-green-500' },
                    { id: 'lost', name: 'Lost', color: 'bg-red-500' }
                ];

                this.init();
            }

            init() {
                this.loadFromLocalStorage();
                this.setupFirebase();
                this.setupEventListeners();
                this.render();
            }

            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.state.isOnline = true;
                    this.render();
                });
                window.addEventListener('offline', () => {
                    this.state.isOnline = false;
                    this.render();
                });
            }

            async setupFirebase() {
                if (FIREBASE_CONFIG.apiKey !== "YOUR-API-KEY") {
                    this.state.isFirebaseConfigured = true;
                    
                    try {
                        // Load Firebase scripts
                        await this.loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
                        await this.loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js');
                        
                        if (window.firebase) {
                            window.firebase.initializeApp(FIREBASE_CONFIG);
                            this.state.firebaseDb = window.firebase.database();
                            this.setupFirebaseListeners();
                        }
                    } catch (error) {
                        console.error('Error loading Firebase:', error);
                        this.state.isFirebaseConfigured = false;
                    }
                }
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            loadFromLocalStorage() {
                const customers = JSON.parse(localStorage.getItem('customers') || '[]');
                const opportunities = JSON.parse(localStorage.getItem('opportunities') || '[]');
                const quotes = JSON.parse(localStorage.getItem('quotes') || '[]');
                const activities = JSON.parse(localStorage.getItem('activities') || '[]');

                if (customers.length === 0 && opportunities.length === 0 && activities.length === 0) {
                    // Initialize with sample data
                    this.state.customers = [
                        {
                            id: '1',
                            name: 'Apex Construction Inc.',
                            industry: 'Metal Buildings',
                            contact: 'John Davidson',
                            email: 'john@apexconstruction.com',
                            phone: '(555) 123-4567',
                            status: 'active',
                            pipelineStage: 'quote_out',
                            companyBackground: 'Leading construction company specializing in commercial metal buildings. Founded in 1995, serving the tri-state area.',
                            productsUsed: 'Square tubing (2x2, 3x3), Round pipes (various diameters), Galvanized steel sheets',
                            deliveryPreferences: 'Job site delivery required, 48-hour notice preferred',
                            paymentTerms: 'Net 30, 2% discount for early payment',
                            website: 'https://www.apexconstruction.com',
                            linkedIn: 'https://linkedin.com/company/apex-construction-inc',
                            decisionMakers: 'John Davidson (Owner), Sarah Miller (Procurement Manager), Mike Chen (Project Manager)',
                            budgetCycles: 'Annual budget set in Q4, project-based purchasing throughout year',
                            lastActivity: new Date().toISOString(),
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: '2',
                            name: 'Tech Innovations Corp',
                            industry: 'Racking - Computer Servers',
                            contact: 'Sarah Chen',
                            email: 'sarah@techinnovations.com',
                            phone: '(555) 987-6543',
                            status: 'active',
                            pipelineStage: 'lead',
                            companyBackground: 'Technology company focused on data center infrastructure and server rack solutions.',
                            productsUsed: 'Custom server racks, cable management systems, cooling solutions',
                            deliveryPreferences: 'Dock delivery, installation services required',
                            paymentTerms: 'Net 45, purchase orders required',
                            website: 'https://www.techinnovations.com',
                            linkedIn: 'https://linkedin.com/company/tech-innovations-corp',
                            decisionMakers: 'Sarah Chen (CTO), Robert Kim (Facilities Director)',
                            budgetCycles: 'Fiscal year July-June, major purchases in Q1 and Q3',
                            lastActivity: new Date().toISOString(),
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }
                    ];

                    this.state.opportunities = [
                        {
                            id: '1',
                            customerId: '1',
                            title: 'Q1 2025 Bulk Order',
                            value: 125000,
                            stage: 'negotiation',
                            salesRep: 'Kaleb Smith',
                            expectedClose: '2025-03-31',
                            createdAt: new Date().toISOString(),
                            lastActivity: null
                        }
                    ];

                    this.state.activities = [
                        {
                            id: '1',
                            customerId: '1',
                            type: 'email',
                            subject: 'Quote sent for Q1 order',
                            date: new Date().toISOString().split('T')[0],
                            time: '10:00 AM',
                            notes: 'Sent detailed quote with volume pricing',
                            completed: true,
                            pipelineStage: 'quote_out',
                            followUpCreated: false,
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: '2',
                            customerId: '1',
                            type: 'call',
                            subject: 'Follow up with Apex Construction Inc.',
                            date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                            time: '2:00 PM',
                            notes: 'Scheduled from customer tab - discuss pricing and delivery timeline',
                            completed: false,
                            pipelineStage: 'quote_out',
                            followUpCreated: false,
                            createdAt: new Date().toISOString()
                        }
                    ];

                    this.state.quotes = [];

                    // Save to localStorage
                    this.saveAllToLocalStorage();
                } else {
                    this.state.customers = customers;
                    this.state.opportunities = opportunities;
                    this.state.quotes = quotes;
                    this.state.activities = activities;
                }
            }

            saveAllToLocalStorage() {
                localStorage.setItem('customers', JSON.stringify(this.state.customers));
                localStorage.setItem('opportunities', JSON.stringify(this.state.opportunities));
                localStorage.setItem('quotes', JSON.stringify(this.state.quotes));
                localStorage.setItem('activities', JSON.stringify(this.state.activities));
            }

            setupFirebaseListeners() {
                const db = this.state.firebaseDb;
                let isInitialLoad = true;

                // Setup listeners for each collection
                ['customers', 'opportunities', 'activities', 'quotes'].forEach(collection => {
                    db.ref(collection).on('value', (snapshot) => {
                        const data = snapshot.val();
                        const localData = this.state[collection];

                        if (!data && localData.length > 0 && isInitialLoad) {
                            // Sync local to Firebase if Firebase is empty
                            const dataObj = {};
                            localData.forEach(item => {
                                dataObj[item.id] = item;
                            });
                            db.ref(collection).set(dataObj);
                            return;
                        }

                        if (data && !isInitialLoad) {
                            const dataArray = Object.entries(data).map(([id, item]) => ({
                                ...item,
                                id: id
                            }));
                            this.state[collection] = dataArray;
                            localStorage.setItem(collection, JSON.stringify(dataArray));
                            this.render();
                        }
                    });
                });

                setTimeout(() => {
                    isInitialLoad = false;
                    this.state.lastSync = new Date().toISOString();
                }, 2000);
            }

            // Icon components as functions
            icon(name, size = 20, className = "") {
                const icons = {
                    Search: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>`,
                    Plus: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>`,
                    Phone: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>`,
                    Mail: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>`,
                    Calendar: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>`,
                    FileText: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>`,
                    BarChart3: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>`,
                    Users: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>`,
                    Package: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>`,
                    DollarSign: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>`,
                    TrendingUp: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>`,
                    Eye: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>`,
                    Edit2: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                    </svg>`,
                    Trash2: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>`,
                    Check: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>`,
                    X: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>`,
                    Clock: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>`,
                    AlertCircle: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>`,
                    Cloud: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                    </svg>`,
                    CloudOff: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>`,
                    RefreshCw: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>`,
                    Menu: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>`,
                    Globe: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>`,
                    LinkedIn: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                        <rect x="2" y="9" width="4" height="12"></rect>
                        <circle cx="4" cy="4" r="2"></circle>
                    </svg>`
                };
                return icons[name] || '';
            }

            // Calculate metrics
            getMetrics() {
                const openOpportunities = this.state.opportunities.filter(o => o.stage !== 'won' && o.stage !== 'lost');
                return {
                    openOpportunities: openOpportunities.length,
                    totalPipeline: openOpportunities.reduce((sum, o) => sum + (o.value || 0), 0),
                    wonDeals: this.state.opportunities.filter(o => o.stage === 'won').reduce((sum, o) => sum + (o.value || 0), 0),
                    activeCustomers: this.state.customers.filter(c => c.status === 'active').length,
                    winRate: this.state.opportunities.length > 0 
                        ? Math.round((this.state.opportunities.filter(o => o.stage === 'won').length / this.state.opportunities.length) * 100)
                        : 0
                };
            }

            // CRUD Operations
            handleAddCustomer() {
                const newCustomer = {
                    id: Date.now().toString(),
                    ...this.state.formData,
                    industry: this.state.formData.industry === 'Other' 
                        ? (this.state.formData.customIndustry || 'Other') 
                        : this.state.formData.industry,
                    status: this.state.formData.status || 'prospect',
                    pipelineStage: this.state.formData.pipelineStage || 'lead',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                delete newCustomer.customIndustry;
                
                this.state.customers.push(newCustomer);
                localStorage.setItem('customers', JSON.stringify(this.state.customers));
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`customers/${newCustomer.id}`).set(newCustomer);
                }
                
                this.closeModal();
            }

            handleUpdateCustomer() {
                const updatedData = {
                    ...this.state.formData,
                    industry: this.state.formData.industry === 'Other' 
                        ? (this.state.formData.customIndustry || 'Other') 
                        : this.state.formData.industry
                };
                
                delete updatedData.customIndustry;
                
                const index = this.state.customers.findIndex(c => c.id === this.state.editingCustomer.id);
                if (index !== -1) {
                    this.state.customers[index] = {
                        ...this.state.editingCustomer,
                        ...updatedData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    localStorage.setItem('customers', JSON.stringify(this.state.customers));
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`customers/${this.state.editingCustomer.id}`)
                            .set(this.state.customers[index]);
                    }
                }
                
                this.closeModal();
            }

            handleDeleteCustomer(customerId) {
                if (confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                    this.state.customers = this.state.customers.filter(c => c.id !== customerId);
                    this.state.opportunities = this.state.opportunities.filter(o => o.customerId !== customerId);
                    this.state.activities = this.state.activities.filter(a => a.customerId !== customerId);
                    
                    this.saveAllToLocalStorage();
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`customers/${customerId}`).remove();
                        // Also remove related data
                        this.state.opportunities.forEach(o => {
                            if (o.customerId === customerId) {
                                this.state.firebaseDb.ref(`opportunities/${o.id}`).remove();
                            }
                        });
                        this.state.activities.forEach(a => {
                            if (a.customerId === customerId) {
                                this.state.firebaseDb.ref(`activities/${a.id}`).remove();
                            }
                        });
                    }
                    
                    this.render();
                }
            }

            handleAddOpportunity() {
                const newOpportunity = {
                    id: Date.now().toString(),
                    ...this.state.formData,
                    stage: 'new',
                    salesRep: 'Kaleb Smith',
                    createdAt: new Date().toISOString(),
                    lastActivity: null
                };
                
                this.state.opportunities.push(newOpportunity);
                localStorage.setItem('opportunities', JSON.stringify(this.state.opportunities));
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`opportunities/${newOpportunity.id}`).set(newOpportunity);
                }
                
                // Update customer pipeline stage
                if (this.state.formData.customerId) {
                    const customer = this.state.customers.find(c => c.id === this.state.formData.customerId);
                    if (customer) {
                        customer.pipelineStage = 'qualified';
                        customer.updatedAt = new Date().toISOString();
                        localStorage.setItem('customers', JSON.stringify(this.state.customers));
                        
                        if (this.state.firebaseDb && this.state.isOnline) {
                            this.state.firebaseDb.ref(`customers/${customer.id}`).set(customer);
                        }
                    }
                }
                
                // Create initial activity if requested
                if (this.state.formData.createActivity) {
                    const newActivity = {
                        id: (Date.now() + 1).toString(),
                        customerId: this.state.formData.customerId,
                        opportunityId: newOpportunity.id,
                        type: 'call',
                        subject: `Initial discussion: ${this.state.formData.title}`,
                        date: this.state.formData.activityDate || new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: '10:00 AM',
                        notes: `Follow up on new opportunity: ${this.state.formData.title}`,
                        completed: false,
                        pipelineStage: 'qualified',
                        createdAt: new Date().toISOString()
                    };
                    
                    this.state.activities.push(newActivity);
                    localStorage.setItem('activities', JSON.stringify(this.state.activities));
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`activities/${newActivity.id}`).set(newActivity);
                    }
                }
                
                this.closeModal();
            }

            handleAddQuote() {
                const newQuote = {
                    id: Date.now().toString(),
                    quoteNumber: `Q-${new Date().getFullYear()}-${String(this.state.quotes.length + 1).padStart(3, '0')}`,
                    ...this.state.formData,
                    status: 'draft',
                    createdAt: new Date().toISOString()
                };
                
                this.state.quotes.push(newQuote);
                localStorage.setItem('quotes', JSON.stringify(this.state.quotes));
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`quotes/${newQuote.id}`).set(newQuote);
                }
                
                this.closeModal();
            }

            handleAddActivity() {
                const newActivity = {
                    id: Date.now().toString(),
                    ...this.state.formData,
                    completed: false,
                    followUpCreated: false,
                    pipelineStage: this.state.formData.pipelineStage || 
                        this.state.customers.find(c => c.id === this.state.formData.customerId)?.pipelineStage || 'lead',
                    createdAt: new Date().toISOString()
                };
                
                this.state.activities.push(newActivity);
                localStorage.setItem('activities', JSON.stringify(this.state.activities));
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`activities/${newActivity.id}`).set(newActivity);
                }
                
                // Update customer's pipeline stage if provided
                if (this.state.formData.pipelineStage && this.state.formData.customerId) {
                    const customer = this.state.customers.find(c => c.id === this.state.formData.customerId);
                    if (customer) {
                        customer.pipelineStage = this.state.formData.pipelineStage;
                        customer.lastActivity = new Date().toISOString();
                        localStorage.setItem('customers', JSON.stringify(this.state.customers));
                        
                        if (this.state.firebaseDb && this.state.isOnline) {
                            this.state.firebaseDb.ref(`customers/${customer.id}`).set(customer);
                        }
                    }
                }
                
                this.closeModal();
            }

            markActivityComplete(activity) {
                activity.completed = true;
                activity.completedDate = new Date().toISOString();
                
                localStorage.setItem('activities', JSON.stringify(this.state.activities));
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`activities/${activity.id}`).set(activity);
                }
                
                // Update customer's last activity
                const customer = this.state.customers.find(c => c.id === activity.customerId);
                if (customer) {
                    customer.lastActivity = new Date().toISOString();
                    localStorage.setItem('customers', JSON.stringify(this.state.customers));
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`customers/${customer.id}`).set(customer);
                    }
                }
                
                this.state.showFollowUp = activity;
                this.render();
            }

            createFollowUp(originalActivity, followUpData) {
                const newActivity = {
                    id: Date.now().toString(),
                    customerId: originalActivity.customerId,
                    type: followUpData.type,
                    subject: followUpData.subject,
                    date: followUpData.date,
                    time: followUpData.time,
                    notes: followUpData.notes,
                    completed: false,
                    followUpCreated: false,
                    pipelineStage: followUpData.pipelineStage,
                    createdAt: new Date().toISOString()
                };
                
                this.state.activities.push(newActivity);
                localStorage.setItem('activities', JSON.stringify(this.state.activities));
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`activities/${newActivity.id}`).set(newActivity);
                }
                
                // Update customer pipeline stage
                if (followUpData.pipelineStage) {
                    const customer = this.state.customers.find(c => c.id === originalActivity.customerId);
                    if (customer) {
                        customer.pipelineStage = followUpData.pipelineStage;
                        customer.updatedAt = new Date().toISOString();
                        localStorage.setItem('customers', JSON.stringify(this.state.customers));
                        
                        if (this.state.firebaseDb && this.state.isOnline) {
                            this.state.firebaseDb.ref(`customers/${customer.id}`).set(customer);
                        }
                    }
                }
                
                // Mark original activity as having follow-up
                originalActivity.followUpCreated = true;
                localStorage.setItem('activities', JSON.stringify(this.state.activities));
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`activities/${originalActivity.id}`).set(originalActivity);
                }
                
                this.state.showFollowUp = null;
                this.render();
            }

            deleteActivity(id) {
                if (confirm('Delete this activity?')) {
                    this.state.activities = this.state.activities.filter(a => a.id !== id);
                    localStorage.setItem('activities', JSON.stringify(this.state.activities));
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`activities/${id}`).remove();
                    }
                    
                    this.render();
                }
            }

            // Modal handling
            openModal(type) {
                this.state.showModal = type;
                this.state.formData = {};
                this.state.editingCustomer = null;
                this.render();
            }

            closeModal() {
                this.state.showModal = null;
                this.state.formData = {};
                this.state.editingCustomer = null;
                this.render();
            }

            // Render methods for each view
            renderNavigation() {
                return `
                    <!-- Mobile Header -->
                    <div class="lg:hidden bg-gray-900 text-white p-4 flex items-center justify-between fixed top-0 left-0 right-0 z-50 safe-top">
                        <div>
                            <h1 class="text-xl font-bold">Major Metals CRM</h1>
                            <p class="text-gray-400 text-xs">Steel Tubing Solutions</p>
                        </div>
                        <button onclick="app.toggleMobileMenu()" class="p-2 hover:bg-gray-800 rounded-lg">
                            ${this.icon('Menu', 24)}
                        </button>
                    </div>
                    
                    <!-- Mobile Menu Overlay -->
                    ${this.state.mobileMenuOpen ? `
                        <div class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-40" style="padding-top: 80px"
                             onclick="app.toggleMobileMenu()"></div>
                    ` : ''}
                    
                    <!-- Navigation Sidebar -->
                    <div class="bg-gray-900 text-white w-64 min-h-screen p-4 flex flex-col fixed lg:static lg:translate-x-0 transition-transform z-40 ${
                        this.state.mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'
                    }" style="padding-top: ${this.state.mobileMenuOpen ? '80px' : '16px'}">
                        <div class="mb-8 hidden lg:block">
                            <h1 class="text-2xl font-bold">Major Metals CRM</h1>
                            <p class="text-gray-400 text-sm">Steel Tubing Solutions</p>
                        </div>
                        
                        <nav class="space-y-2 flex-1">
                            ${[
                                { id: 'dashboard', icon: 'BarChart3', label: 'Dashboard' },
                                { id: 'customers', icon: 'Users', label: 'Customers' },
                                { id: 'pipeline', icon: 'TrendingUp', label: 'Sales Pipeline' },
                                { id: 'quotes', icon: 'FileText', label: 'Quotes' },
                                { id: 'activities', icon: 'Calendar', label: 'Activities' }
                            ].map(item => `
                                <button onclick="app.setView('${item.id}')" 
                                        class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg transition-colors ${
                                            this.state.activeView === item.id ? 'bg-blue-600' : 'hover:bg-gray-800'
                                        }">
                                    ${this.icon(item.icon, 20)}
                                    <span>${item.label}</span>
                                </button>
                            `).join('')}
                        </nav>
                        
                        <div class="mt-8 pt-8 border-t border-gray-800">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    ${this.state.isOnline ? 
                                        this.icon('Cloud', 16, 'text-green-500') : 
                                        this.icon('CloudOff', 16, 'text-red-500')
                                    }
                                    <span class="text-xs text-gray-400">
                                        ${this.state.isOnline ? 'Online' : 'Offline'}
                                    </span>
                                </div>
                                ${this.state.isSyncing ? 
                                    this.icon('RefreshCw', 16, 'text-blue-500 animate-spin') : ''
                                }
                            </div>
                            ${this.state.lastSync ? `
                                <p class="text-xs text-gray-500">
                                    Last sync: ${new Date(this.state.lastSync).toLocaleTimeString()}
                                </p>
                            ` : ''}
                            ${!this.state.isFirebaseConfigured ? `
                                <p class="text-xs text-yellow-500 mt-2">Local storage only</p>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            renderDashboard() {
                const metrics = this.getMetrics();
                
                return `
                    <div class="p-4 lg:p-8">
                        <h2 class="text-2xl lg:text-3xl font-bold mb-6 lg:mb-8">Sales Dashboard</h2>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-6 lg:mb-8">
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    ${this.icon('Package', 24, 'text-blue-500')}
                                    <span class="text-sm text-gray-500">Open Opportunities</span>
                                </div>
                                <p class="text-2xl font-bold">${metrics.openOpportunities}</p>
                                <p class="text-sm text-gray-600">$${(metrics.totalPipeline / 1000).toFixed(0)}K in pipeline</p>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    ${this.icon('DollarSign', 24, 'text-green-500')}
                                    <span class="text-sm text-gray-500">Won Deals</span>
                                </div>
                                <p class="text-2xl font-bold">$${(metrics.wonDeals / 1000).toFixed(0)}K</p>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    ${this.icon('TrendingUp', 24, 'text-purple-500')}
                                    <span class="text-sm text-gray-500">Win Rate</span>
                                </div>
                                <p class="text-2xl font-bold">${metrics.winRate}%</p>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    ${this.icon('Users', 24, 'text-orange-500')}
                                    <span class="text-sm text-gray-500">Active Customers</span>
                                </div>
                                <p class="text-2xl font-bold">${metrics.activeCustomers}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <h3 class="text-lg lg:text-xl font-semibold mb-4">Recent Activities</h3>
                                ${this.state.activities.length === 0 ? `
                                    <p class="text-gray-400">No activities yet</p>
                                ` : `
                                    <div class="space-y-3">
                                        ${this.state.activities
                                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                                            .slice(0, 5)
                                            .map(activity => {
                                                const customer = this.state.customers.find(c => c.id === activity.customerId);
                                                return `
                                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                                                        <div class="flex items-center space-x-3">
                                                            ${activity.type === 'call' ? this.icon('Phone', 16) : 
                                                              activity.type === 'email' ? this.icon('Mail', 16) : 
                                                              this.icon('Calendar', 16)}
                                                            <div>
                                                                <p class="font-medium text-sm">${activity.subject}</p>
                                                                <p class="text-xs text-gray-600">
                                                                    ${customer?.name || 'Unknown'} • ${activity.date}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        ${activity.completed ? 
                                                            this.icon('Check', 16, 'text-green-500') : 
                                                            this.icon('Clock', 16, 'text-yellow-500')
                                                        }
                                                    </div>
                                                `;
                                            }).join('')}
                                    </div>
                                `}
                            </div>
                            
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <h3 class="text-lg lg:text-xl font-semibold mb-4">Top Opportunities</h3>
                                ${this.state.opportunities.length === 0 ? `
                                    <p class="text-gray-400">No opportunities yet</p>
                                ` : `
                                    <div class="space-y-2">
                                        ${this.state.opportunities
                                            .filter(o => o.stage !== 'won' && o.stage !== 'lost')
                                            .sort((a, b) => (b.value || 0) - (a.value || 0))
                                            .slice(0, 5)
                                            .map(opp => {
                                                const customer = this.state.customers.find(c => c.id === opp.customerId);
                                                return `
                                                    <div class="p-3 bg-gray-50 rounded">
                                                        <div class="flex justify-between items-start">
                                                            <div>
                                                                <p class="font-medium">${opp.title}</p>
                                                                <p class="text-sm text-gray-600">${customer?.name || 'Unknown'}</p>
                                                            </div>
                                                            <p class="text-sm font-semibold">$${((opp.value || 0) / 1000).toFixed(0)}K</p>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderCustomers() {
                const isCustomIndustry = (industry) => {
                    return industry && !INDUSTRIES.slice(0, -1).includes(industry);
                };

                const getIndustryStats = () => {
                    const stats = {};
                    this.state.customers.forEach(customer => {
                        if (customer.industry) {
                            const industryKey = isCustomIndustry(customer.industry) ? 'Other' : customer.industry;
                            stats[industryKey] = (stats[industryKey] || 0) + 1;
                        } else {
                            stats['No Industry'] = (stats['No Industry'] || 0) + 1;
                        }
                    });
                    return Object.entries(stats)
                        .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
                        .map(([industry, count]) => ({ industry, count }));
                };

                const industryStats = getIndustryStats();

                const filteredCustomers = this.state.customers.filter(c => {
                    const matchesSearch = c.name.toLowerCase().includes(this.state.searchTerm.toLowerCase());
                    let matchesIndustry;
                    
                    if (this.state.industryFilter === 'all') {
                        matchesIndustry = true;
                    } else if (this.state.industryFilter === 'Other') {
                        matchesIndustry = isCustomIndustry(c.industry);
                    } else if (this.state.industryFilter === 'No Industry') {
                        matchesIndustry = !c.industry;
                    } else {
                        matchesIndustry = c.industry === this.state.industryFilter;
                    }
                    
                    return matchesSearch && matchesIndustry;
                });

                return `
                    <div class="p-4 lg:p-8">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 lg:mb-8 space-y-4 sm:space-y-0">
                            <h2 class="text-2xl lg:text-3xl font-bold">Customers</h2>
                            <button onclick="app.openModal('customer')"
                                    class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full sm:w-auto justify-center">
                                ${this.icon('Plus', 20)}
                                <span>Add Customer</span>
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                                    <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 flex-1">
                                        <input type="text" placeholder="Search customers..."
                                               value="${this.state.searchTerm}"
                                               oninput="app.updateSearchTerm(this.value)"
                                               class="flex-1 outline-none px-4 py-2 border rounded-lg">
                                        <select onchange="app.updateIndustryFilter(this.value)"
                                                class="px-4 py-2 border rounded-lg w-full sm:w-auto">
                                            <option value="all">All Industries (${this.state.customers.length})</option>
                                            ${industryStats.map(({ industry, count }) => `
                                                <option value="${industry}" ${this.state.industryFilter === industry ? 'selected' : ''}>
                                                    ${industry} (${count})
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="text-sm text-gray-600 text-center lg:text-left">
                                        Showing ${filteredCustomers.length} of ${this.state.customers.length} customers
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mobile View - Cards -->
                            <div class="lg:hidden">
                                ${filteredCustomers.length === 0 ? `
                                    <div class="p-8 text-center text-gray-500">
                                        No customers found matching your criteria
                                    </div>
                                ` : `
                                    <div class="divide-y">
                                        ${filteredCustomers.map(customer => {
                                            const stage = this.customerStages.find(s => s.id === customer.pipelineStage);
                                            return `
                                                <div class="p-4">
                                                    <div class="mb-3">
                                                        <h3 class="font-semibold text-lg">${customer.name}</h3>
                                                        <p class="text-sm text-gray-600">${customer.industry || '-'}</p>
                                                    </div>
                                                    <div class="space-y-2 text-sm">
                                                        <div class="flex items-center space-x-2">
                                                            ${this.icon('Users', 16, 'text-gray-400')}
                                                            <span>${customer.contact}</span>
                                                        </div>
                                                        <div class="flex items-center space-x-2">
                                                            ${this.icon('Mail', 16, 'text-gray-400')}
                                                            <span class="break-all">${customer.email}</span>
                                                        </div>
                                                        <div class="flex items-center space-x-2">
                                                            ${this.icon('Phone', 16, 'text-gray-400')}
                                                            <span>${customer.phone}</span>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3 flex items-center justify-between">
                                                        <div class="flex items-center space-x-2">
                                                            <span class="px-2 py-1 text-xs rounded-full ${
                                                                customer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                                            }">
                                                                ${customer.status}
                                                            </span>
                                                            ${stage ? `
                                                                <span class="px-2 py-1 text-xs rounded-full text-white ${stage.color}">
                                                                    ${stage.name}
                                                                </span>
                                                            ` : ''}
                                                        </div>
                                                        <div class="flex items-center space-x-3">
                                                            <button onclick="app.viewCustomerDetails('${customer.id}')"
                                                                    class="text-blue-600 hover:text-blue-800 p-2"
                                                                    title="View Details">
                                                                ${this.icon('Eye', 18)}
                                                            </button>
                                                            <button onclick="app.scheduleActivityForCustomer('${customer.id}')"
                                                                    class="text-purple-600 hover:text-purple-800 p-2"
                                                                    title="Schedule Activity">
                                                                ${this.icon('Calendar', 18)}
                                                            </button>
                                                            <button onclick="app.editCustomer('${customer.id}')"
                                                                    class="text-blue-600 hover:text-blue-800 p-2"
                                                                    title="Edit Customer">
                                                                ${this.icon('Edit2', 18)}
                                                            </button>
                                                            <button onclick="app.handleDeleteCustomer('${customer.id}')"
                                                                    class="text-red-600 hover:text-red-800 p-2"
                                                                    title="Delete Customer">
                                                                ${this.icon('Trash2', 18)}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                            </div>
                            
                            <!-- Desktop View - Table -->
                            <div class="hidden lg:block overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50 border-b">
                                        <tr>
                                            <th class="text-left p-4">Company</th>
                                            <th class="text-left p-4">Industry</th>
                                            <th class="text-left p-4">Contact</th>
                                            <th class="text-left p-4">Email</th>
                                            <th class="text-left p-4">Phone</th>
                                            <th class="text-left p-4">Status</th>
                                            <th class="text-left p-4">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredCustomers.map(customer => {
                                            const stage = this.customerStages.find(s => s.id === customer.pipelineStage);
                                            return `
                                                <tr class="border-b hover:bg-gray-50">
                                                    <td class="p-4">${customer.name}</td>
                                                    <td class="p-4 text-sm text-gray-600">${customer.industry || '-'}</td>
                                                    <td class="p-4">${customer.contact}</td>
                                                    <td class="p-4">${customer.email}</td>
                                                    <td class="p-4">${customer.phone}</td>
                                                    <td class="p-4">
                                                        <span class="px-2 py-1 text-xs rounded-full ${
                                                            customer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                                        }">
                                                            ${customer.status}
                                                        </span>
                                                        ${stage ? `
                                                            <span class="ml-2 px-2 py-1 text-xs rounded-full text-white ${stage.color}">
                                                                ${stage.name}
                                                            </span>
                                                        ` : ''}
                                                    </td>
                                                    <td class="p-4">
                                                        <div class="flex items-center space-x-2">
                                                            <button onclick="app.viewCustomerDetails('${customer.id}')"
                                                                    class="text-blue-600 hover:text-blue-800"
                                                                    title="View Details">
                                                                ${this.icon('Eye', 16)}
                                                            </button>
                                                            <button onclick="app.scheduleActivityForCustomer('${customer.id}')"
                                                                    class="text-purple-600 hover:text-purple-800"
                                                                    title="Schedule Activity">
                                                                ${this.icon('Calendar', 16)}
                                                            </button>
                                                            <button onclick="app.editCustomer('${customer.id}')"
                                                                    class="text-blue-600 hover:text-blue-800"
                                                                    title="Edit Customer">
                                                                ${this.icon('Edit2', 16)}
                                                            </button>
                                                            <button onclick="app.handleDeleteCustomer('${customer.id}')"
                                                                    class="text-red-600 hover:text-red-800"
                                                                    title="Delete Customer">
                                                                ${this.icon('Trash2', 16)}
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                                ${filteredCustomers.length === 0 ? `
                                    <div class="p-8 text-center text-gray-500">
                                        No customers found matching your criteria
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderPipeline() {
                return `
                    <div class="p-4 lg:p-8">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 lg:mb-8 space-y-4 sm:space-y-0">
                            <h2 class="text-2xl lg:text-3xl font-bold">Sales Pipeline</h2>
                            <button onclick="app.openModal('opportunity')"
                                    class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full sm:w-auto justify-center">
                                ${this.icon('Plus', 20)}
                                <span>Add Opportunity</span>
                            </button>
                        </div>
                        
                        <div class="flex space-x-4 overflow-x-auto pb-4 -mx-4 px-4 lg:mx-0 lg:px-0">
                            ${this.pipelineStages.map(stage => {
                                const stageOpps = this.state.opportunities.filter(o => o.stage === stage.id);
                                const stageValue = stageOpps.reduce((sum, o) => sum + (o.value || 0), 0);
                                
                                return `
                                    <div class="flex-shrink-0 w-72 lg:w-80"
                                         ondragover="event.preventDefault()"
                                         ondrop="app.handleDrop(event, '${stage.id}')">
                                        <div class="${stage.color} text-white p-3 rounded-t-lg">
                                            <h3 class="font-semibold">${stage.name}</h3>
                                            <p class="text-sm opacity-90">
                                                ${stageOpps.length} deals • ${(stageValue / 1000).toFixed(0)}K
                                            </p>
                                        </div>
                                        
                                        <div class="bg-gray-100 min-h-[400px] p-2">
                                            ${stageOpps.map(opp => {
                                                const customer = this.state.customers.find(c => c.id === opp.customerId);
                                                const activityCount = this.state.activities.filter(a => a.opportunityId === opp.id).length;
                                                const recentActivity = this.state.activities
                                                    .filter(a => a.opportunityId === opp.id)
                                                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                                                
                                                return `
                                                    <div draggable="true"
                                                         ondragstart="app.handleDragStart(event, '${opp.id}')"
                                                         class="bg-white p-3 rounded-lg shadow mb-2 cursor-move hover:shadow-md transition-shadow"
                                                         onclick="app.showOpportunityDetails('${opp.id}')">
                                                        <h4 class="font-medium">${opp.title}</h4>
                                                        <p class="text-sm text-gray-600 mt-1">${customer?.name || 'Unknown'}</p>
                                                        <div class="flex justify-between items-center mt-3">
                                                            <span class="text-lg font-semibold">${((opp.value || 0) / 1000).toFixed(0)}K</span>
                                                            <span class="text-sm text-gray-500">${opp.salesRep}</span>
                                                        </div>
                                                        <div class="mt-2 text-xs text-gray-500">
                                                            <p>Close: ${opp.expectedClose || 'Not set'}</p>
                                                            ${recentActivity ? `
                                                                <p class="mt-1 flex items-center">
                                                                    ${this.icon('Clock', 12, 'mr-1')}
                                                                    Last: ${recentActivity.subject.substring(0, 20)}...
                                                                </p>
                                                            ` : `
                                                                <p class="mt-1 text-orange-600">No activities yet</p>
                                                            `}
                                                        </div>
                                                        <div class="mt-2 flex justify-between items-center">
                                                            <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                                                ${activityCount} activities
                                                            </span>
                                                            <button onclick="event.stopPropagation(); app.createActivityForOpportunity('${opp.id}')"
                                                                    class="text-blue-600 hover:text-blue-800 p-1">
                                                                ${this.icon('Plus', 16)}
                                                            </button>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${this.renderOpportunityDetailsModal()}
                    </div>
                `;
            }

            renderOpportunityDetailsModal() {
                if (!this.state.selectedOpp) return '';
                
                const opp = this.state.selectedOpp;
                const customer = this.state.customers.find(c => c.id === opp.customerId);
                const stage = this.pipelineStages.find(s => s.id === opp.stage);
                const activities = this.state.activities.filter(a => a.opportunityId === opp.id);
                
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeOpportunityDetails()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-4 lg:p-6"
                             onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg lg:text-xl font-semibold">${opp.title}</h3>
                                <button onclick="app.closeOpportunityDetails()" class="text-gray-500 hover:text-gray-700 p-1">
                                    ${this.icon('X', 24)}
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Customer</p>
                                        <p class="font-medium">${customer?.name || 'Unknown'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Value</p>
                                        <p class="font-medium">${opp.value?.toLocaleString()}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Stage</p>
                                        <p class="font-medium">${stage?.name}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Expected Close</p>
                                        <p class="font-medium">${opp.expectedClose || 'Not set'}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="font-semibold">Related Activities</h4>
                                        <button onclick="app.createActivityForOpportunity('${opp.id}'); app.closeOpportunityDetails();"
                                                class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                                            ${this.icon('Plus', 16, 'mr-1')}
                                            Add Activity
                                        </button>
                                    </div>
                                    <div class="space-y-2 max-h-64 overflow-y-auto">
                                        ${activities.length === 0 ? `
                                            <p class="text-gray-400 text-sm">No activities yet</p>
                                        ` : activities
                                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                                            .map(activity => `
                                                <div class="p-3 bg-gray-50 rounded">
                                                    <div class="flex items-center justify-between">
                                                        <div>
                                                            <p class="font-medium text-sm">${activity.subject}</p>
                                                            <p class="text-xs text-gray-600">
                                                                ${activity.date} • ${activity.type}
                                                                ${activity.completed ? ' • Completed' : ''}
                                                            </p>
                                                        </div>
                                                        ${activity.completed ? 
                                                            this.icon('Check', 16, 'text-green-500') : 
                                                            this.icon('Clock', 16, 'text-yellow-500')
                                                        }
                                                    </div>
                                                </div>
                                            `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderQuotes() {
                return `
                    <div class="p-4 lg:p-8 mt-16 lg:mt-0">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 lg:mb-8 space-y-4 sm:space-y-0">
                            <h2 class="text-2xl lg:text-3xl font-bold">Quotes</h2>
                            <button onclick="app.openModal('quote')"
                                    class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full sm:w-auto justify-center">
                                ${this.icon('Plus', 20)}
                                <span>Create Quote</span>
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                            ${this.state.quotes.length === 0 ? `
                                <p class="text-gray-400">No quotes yet</p>
                            ` : `
                                <div class="space-y-3">
                                    ${this.state.quotes.map(quote => {
                                        const customer = this.state.customers.find(c => c.id === quote.customerId);
                                        return `
                                            <div class="p-4 border rounded-lg">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <h4 class="font-semibold">${quote.quoteNumber}</h4>
                                                        <p class="text-sm text-gray-600">${customer?.name || 'Unknown'}</p>
                                                    </div>
                                                    <span class="px-2 py-1 text-xs rounded-full ${
                                                        quote.status === 'sent' ? 'bg-blue-100 text-blue-800' :
                                                        quote.status === 'accepted' ? 'bg-green-100 text-green-800' :
                                                        'bg-gray-100 text-gray-800'
                                                    }">
                                                        ${quote.status}
                                                    </span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            renderActivities() {
                const today = new Date().toISOString().split('T')[0];
                
                const filteredActivities = this.state.activities.filter(activity => {
                    if (this.state.activityFilter === 'all') return true;
                    if (this.state.activityFilter === 'overdue') return !activity.completed && activity.date < today;
                    if (this.state.activityFilter === 'today') return activity.date === today;
                    if (this.state.activityFilter === 'upcoming') return !activity.completed && activity.date >= today;
                    
                    const customer = this.state.customers.find(c => c.id === activity.customerId);
                    if (this.state.activityFilter === 'quotes_out') return customer?.pipelineStage === 'quote_out';
                    if (this.state.activityFilter === 'po_pending') return customer?.pipelineStage === 'po_pending';
                    if (this.state.activityFilter === 'po_received') return customer?.pipelineStage === 'po_received';
                    
                    return activity.pipelineStage === this.state.activityFilter;
                });

                const upcomingActivities = filteredActivities.filter(a => !a.completed && a.date >= today);
                const overdueActivities = filteredActivities.filter(a => !a.completed && a.date < today);
                const completedActivities = filteredActivities.filter(a => a.completed);

                const getActivityIcon = (type) => {
                    switch(type) {
                        case 'call': return this.icon('Phone', 20, 'text-blue-500');
                        case 'email': return this.icon('Mail', 20, 'text-green-500');
                        case 'meeting': return this.icon('Calendar', 20, 'text-purple-500');
                        default: return this.icon('Clock', 20, 'text-gray-500');
                    }
                };

                return `
                    <div class="p-4 lg:p-8 mt-16 lg:mt-0">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 lg:mb-8 space-y-4 sm:space-y-0">
                            <h2 class="text-2xl lg:text-3xl font-bold">Activities & Follow-ups</h2>
                            <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                                <select onchange="app.updateActivityFilter(this.value)"
                                        class="px-4 py-2 border rounded-lg w-full sm:w-auto">
                                    <option value="all">All Activities</option>
                                    <option value="today">Today</option>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="overdue">Overdue</option>
                                    <optgroup label="Pipeline Stages">
                                        <option value="quotes_out">Quotes Out</option>
                                        <option value="po_pending">PO Pending</option>
                                        <option value="po_received">PO Received</option>
                                    </optgroup>
                                </select>
                                <button onclick="app.openModal('activity')"
                                        class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full sm:w-auto justify-center">
                                    ${this.icon('Plus', 20)}
                                    <span>Schedule Activity</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
                            <!-- Main Activity List -->
                            <div class="lg:col-span-2 space-y-4 lg:space-y-6">
                                <!-- Overdue Activities -->
                                ${overdueActivities.length > 0 ? `
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                        <h3 class="text-lg font-semibold text-red-800 mb-3 flex items-center">
                                            ${this.icon('AlertCircle', 20, 'mr-2')}
                                            Overdue Activities (${overdueActivities.length})
                                        </h3>
                                        <div class="space-y-2">
                                            ${overdueActivities.map(activity => {
                                                const customer = this.state.customers.find(c => c.id === activity.customerId);
                                                const stage = this.customerStages.find(s => s.id === customer?.pipelineStage);
                                                return `
                                                    <div class="bg-white p-4 rounded-lg border border-red-200">
                                                        <div class="flex items-start justify-between">
                                                            <div class="flex items-start space-x-3 flex-1">
                                                                ${getActivityIcon(activity.type)}
                                                                <div class="flex-1">
                                                                    <h4 class="font-medium text-gray-900">${activity.subject}</h4>
                                                                    <p class="text-sm text-gray-600 mt-1">
                                                                        ${customer?.name || 'Unknown Customer'}
                                                                        ${stage ? `
                                                                            <span class="ml-2 px-2 py-1 text-xs rounded-full text-white ${stage.color}">
                                                                                ${stage.name}
                                                                            </span>
                                                                        ` : ''}
                                                                    </p>
                                                                    <p class="text-sm text-red-600 mt-1">
                                                                        Due: ${activity.date} at ${activity.time}
                                                                    </p>
                                                                    ${activity.notes ? `
                                                                        <p class="text-sm text-gray-500 mt-2">${activity.notes}</p>
                                                                    ` : ''}
                                                                </div>
                                                            </div>
                                                            <div class="flex items-center space-x-2 ml-2">
                                                                <button onclick="app.markActivityComplete('${activity.id}')"
                                                                        class="text-green-600 hover:text-green-800 p-1"
                                                                        title="Mark Complete">
                                                                    ${this.icon('Check', 20)}
                                                                </button>
                                                                <button onclick="app.deleteActivity('${activity.id}')"
                                                                        class="text-red-600 hover:text-red-800 p-1"
                                                                        title="Delete">
                                                                    ${this.icon('Trash2', 16)}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Upcoming Activities -->
                                <div class="bg-white rounded-lg shadow">
                                    <div class="p-4 border-b">
                                        <h3 class="text-lg font-semibold">
                                            ${this.state.activityFilter === 'all' ? 'Upcoming Activities' : 'Filtered Activities'} (${upcomingActivities.length})
                                        </h3>
                                    </div>
                                    <div class="p-4">
                                        ${upcomingActivities.length === 0 ? `
                                            <p class="text-gray-400 text-center py-8">No activities found</p>
                                        ` : `
                                            <div class="space-y-3">
                                                ${upcomingActivities.map(activity => {
                                                    const customer = this.state.customers.find(c => c.id === activity.customerId);
                                                    const stage = this.customerStages.find(s => s.id === customer?.pipelineStage);
                                                    return `
                                                        <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                                            <div class="flex items-start justify-between">
                                                                <div class="flex items-start space-x-3 flex-1">
                                                                    ${getActivityIcon(activity.type)}
                                                                    <div class="flex-1">
                                                                        <h4 class="font-medium text-gray-900">${activity.subject}</h4>
                                                                        <p class="text-sm text-gray-600 mt-1">
                                                                            ${customer?.name || 'Unknown Customer'}
                                                                            ${stage ? `
                                                                                <span class="ml-2 px-2 py-1 text-xs rounded-full text-white ${stage.color}">
                                                                                    ${stage.name}
                                                                                </span>
                                                                            ` : ''}
                                                                        </p>
                                                                        <p class="text-sm text-gray-500 mt-1">
                                                                            ${activity.date} at ${activity.time}
                                                                        </p>
                                                                        ${activity.notes ? `
                                                                            <p class="text-sm text-gray-500 mt-2">${activity.notes}</p>
                                                                        ` : ''}
                                                                    </div>
                                                                </div>
                                                                <div class="flex items-center space-x-2 ml-2">
                                                                    <button onclick="app.markActivityComplete('${activity.id}')"
                                                                            class="text-green-600 hover:text-green-800 p-1"
                                                                            title="Mark Complete">
                                                                        ${this.icon('Check', 20)}
                                                                    </button>
                                                                    <button onclick="app.deleteActivity('${activity.id}')"
                                                                            class="text-red-600 hover:text-red-800 p-1"
                                                                            title="Delete">
                                                                        ${this.icon('Trash2', 16)}
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        `}
                                    </div>
                                </div>
                                
                                <!-- Completed Activities -->
                                <div class="bg-white rounded-lg shadow">
                                    <div class="p-4 border-b">
                                        <h3 class="text-lg font-semibold">Completed Activities (${completedActivities.length})</h3>
                                    </div>
                                    <div class="p-4">
                                        ${completedActivities.length === 0 ? `
                                            <p class="text-gray-400 text-center py-8">No completed activities</p>
                                        ` : `
                                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                                ${completedActivities.slice(0, 20).map(activity => {
                                                    const customer = this.state.customers.find(c => c.id === activity.customerId);
                                                    return `
                                                        <div class="p-3 bg-gray-50 rounded">
                                                            <div class="flex items-center justify-between">
                                                                <div class="flex items-center space-x-2">
                                                                    ${getActivityIcon(activity.type)}
                                                                    <div>
                                                                        <p class="font-medium text-sm">${activity.subject}</p>
                                                                        <p class="text-xs text-gray-600">
                                                                            ${customer?.name || 'Unknown'} • ${activity.date}
                                                                            ${activity.followUpCreated ? `
                                                                                <span class="ml-2 text-blue-600">• Follow-up created</span>
                                                                            ` : ''}
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                                ${this.icon('Check', 16, 'text-green-500')}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Activity Stats Sidebar -->
                            <div class="space-y-4 lg:space-y-6">
                                <!-- Pipeline Summary -->
                                <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                    <h3 class="text-lg font-semibold mb-4">Pipeline Summary</h3>
                                    <div class="space-y-3">
                                        ${this.customerStages.slice(2, 6).map(stage => {
                                            const count = this.state.customers.filter(c => c.pipelineStage === stage.id).length;
                                            return `
                                                <div class="flex justify-between items-center">
                                                    <div class="flex items-center space-x-2">
                                                        <div class="w-3 h-3 rounded-full ${stage.color}"></div>
                                                        <span class="text-sm text-gray-600">${stage.name}</span>
                                                    </div>
                                                    <span class="font-semibold">${count}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <!-- Stats Card -->
                                <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                    <h3 class="text-lg font-semibold mb-4">Activity Summary</h3>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Today's Activities</span>
                                            <span class="font-semibold">
                                                ${this.state.activities.filter(a => a.date === today && !a.completed).length}
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">This Week</span>
                                            <span class="font-semibold">
                                                ${this.state.activities.filter(a => {
                                                    const actDate = new Date(a.date);
                                                    const weekStart = new Date();
                                                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                                                    return actDate >= weekStart && !a.completed;
                                                }).length}
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Overdue</span>
                                            <span class="font-semibold text-red-600">${overdueActivities.length}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Completed (All Time)</span>
                                            <span class="font-semibold text-green-600">${completedActivities.length}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Activity Types Breakdown -->
                                <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                    <h3 class="text-lg font-semibold mb-4">Activity Types</h3>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center space-x-2">
                                                ${this.icon('Phone', 16, 'text-blue-500')}
                                                <span class="text-gray-600">Calls</span>
                                            </div>
                                            <span class="font-semibold">
                                                ${this.state.activities.filter(a => a.type === 'call').length}
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center space-x-2">
                                                ${this.icon('Mail', 16, 'text-green-500')}
                                                <span class="text-gray-600">Emails</span>
                                            </div>
                                            <span class="font-semibold">
                                                ${this.state.activities.filter(a => a.type === 'email').length}
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center space-x-2">
                                                ${this.icon('Calendar', 16, 'text-purple-500')}
                                                <span class="text-gray-600">Meetings</span>
                                            </div>
                                            <span class="font-semibold">
                                                ${this.state.activities.filter(a => a.type === 'meeting').length}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Tips -->
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-medium text-blue-900 mb-2">Quick Tips</h4>
                                    <ul class="text-sm text-blue-800 space-y-1">
                                        <li>• Complete activities to trigger follow-ups</li>
                                        <li>• Update pipeline stages as deals progress</li>
                                        <li>• Filter by stage to focus on priorities</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        ${this.renderFollowUpModal()}
                    </div>
                `;
            }

            renderModal() {
                if (!this.state.showModal) return '';
                
                const modalTitle = this.state.editingCustomer ? 'Edit' : 'Add';
                const modalType = this.state.showModal === 'customer' ? 'Customer' : 
                                 this.state.showModal === 'opportunity' ? 'Opportunity' : 
                                 this.state.showModal === 'quote' ? 'Quote' : 'Activity';
                
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeModal()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
                             onclick="event.stopPropagation()">
                            <div class="sticky top-0 bg-white border-b p-4 lg:p-6">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-lg lg:text-xl font-semibold">${modalTitle} ${modalType}</h3>
                                    <button onclick="app.closeModal()" class="text-gray-500 hover:text-gray-700 p-1">
                                        ${this.icon('X', 24)}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-4 lg:p-6">
                                ${this.renderModalContent()}
                            </div>
                            
                            <div class="sticky bottom-0 bg-white border-t p-4 lg:p-6">
                                <div class="flex justify-end space-x-3">
                                    <button onclick="app.closeModal()"
                                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                        Cancel
                                    </button>
                                    <button onclick="app.handleModalSubmit()"
                                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        ${this.state.editingCustomer && this.state.showModal === 'customer' ? 'Update' : 'Save'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderModalContent() {
                switch(this.state.showModal) {
                    case 'customer':
                        return this.renderCustomerForm();
                    case 'opportunity':
                        return this.renderOpportunityForm();
                    case 'quote':
                        return this.renderQuoteForm();
                    case 'activity':
                        return this.renderActivityForm();
                    default:
                        return '';
                }
            }

            renderCustomerForm() {
                const formData = this.state.formData;
                const isOtherIndustry = formData.industry === 'Other';
                
                return `
                    <div class="space-y-4">
                        <!-- Basic Information Section -->
                        <div class="form-section">
                            <h4 class="form-section-title">Basic Information</h4>
                            <div class="space-y-4">
                                <input type="text" placeholder="Company Name *" 
                                       value="${formData.name || ''}"
                                       onchange="app.updateFormField('name', this.value)"
                                       class="w-full p-2 border rounded" required>
                                
                                <select onchange="app.updateFormField('industry', this.value)"
                                        class="w-full p-2 border rounded">
                                    <option value="">Select Industry</option>
                                    ${INDUSTRIES.map(industry => `
                                        <option value="${industry}" ${formData.industry === industry ? 'selected' : ''}>
                                            ${industry}
                                        </option>
                                    `).join('')}
                                </select>
                                
                                ${isOtherIndustry ? `
                                    <input type="text" placeholder="Enter custom industry"
                                           value="${formData.customIndustry || ''}"
                                           onchange="app.updateFormField('customIndustry', this.value)"
                                           class="w-full p-2 border rounded">
                                ` : ''}
                                
                                <input type="text" placeholder="Contact Name"
                                       value="${formData.contact || ''}"
                                       onchange="app.updateFormField('contact', this.value)"
                                       class="w-full p-2 border rounded">
                                
                                <input type="email" placeholder="Email"
                                       value="${formData.email || ''}"
                                       onchange="app.updateFormField('email', this.value)"
                                       class="w-full p-2 border rounded">
                                
                                <input type="tel" placeholder="Phone"
                                       value="${formData.phone || ''}"
                                       onchange="app.updateFormField('phone', this.value)"
                                       class="w-full p-2 border rounded">
                                
                                <select onchange="app.updateFormField('status', this.value)"
                                        class="w-full p-2 border rounded">
                                    <option value="">Select Status</option>
                                    <option value="prospect" ${formData.status === 'prospect' ? 'selected' : ''}>Prospect</option>
                                    <option value="active" ${formData.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${formData.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                        </div>

                        <!-- Company Profile Section -->
                        <div class="form-section">
                            <h4 class="form-section-title">Company Profile</h4>
                            <div class="space-y-4">
                                <div>
                                    <textarea placeholder="Company Background"
                                              value="${formData.companyBackground || ''}"
                                              onchange="app.updateFormField('companyBackground', this.value)"
                                              oninput="app.updateCharCount('companyBackground', this.value, 500)"
                                              class="w-full p-2 border rounded"
                                              rows="3"
                                              maxlength="500"></textarea>
                                    <div class="char-counter" id="companyBackground-counter">
                                        ${formData.companyBackground ? formData.companyBackground.length : 0}/500
                                    </div>
                                </div>
                                
                                <div>
                                    <textarea placeholder="Products They Typically Use"
                                              value="${formData.productsUsed || ''}"
                                              onchange="app.updateFormField('productsUsed', this.value)"
                                              oninput="app.updateCharCount('productsUsed', this.value, 300)"
                                              class="w-full p-2 border rounded"
                                              rows="2"
                                              maxlength="300"></textarea>
                                    <div class="char-counter" id="productsUsed-counter">
                                        ${formData.productsUsed ? formData.productsUsed.length : 0}/300
                                    </div>
                                </div>
                                
                                <div>
                                    <textarea placeholder="Decision Makers & Roles"
                                              value="${formData.decisionMakers || ''}"
                                              onchange="app.updateFormField('decisionMakers', this.value)"
                                              oninput="app.updateCharCount('decisionMakers', this.value, 300)"
                                              class="w-full p-2 border rounded"
                                              rows="2"
                                              maxlength="300"></textarea>
                                    <div class="char-counter" id="decisionMakers-counter">
                                        ${formData.decisionMakers ? formData.decisionMakers.length : 0}/300
                                    </div>
                                </div>
                                
                                <input type="text" placeholder="Budget Cycles"
                                       value="${formData.budgetCycles || ''}"
                                       onchange="app.updateFormField('budgetCycles', this.value)"
                                       class="w-full p-2 border rounded">
                            </div>
                        </div>

                        <!-- Business Preferences Section -->
                        <div class="form-section">
                            <h4 class="form-section-title">Business Preferences</h4>
                            <div class="space-y-4">
                                <input type="text" placeholder="Delivery Preferences"
                                       value="${formData.deliveryPreferences || ''}"
                                       onchange="app.updateFormField('deliveryPreferences', this.value)"
                                       class="w-full p-2 border rounded">
                                
                                <input type="text" placeholder="Payment Terms"
                                       value="${formData.paymentTerms || ''}"
                                       onchange="app.updateFormField('paymentTerms', this.value)"
                                       class="w-full p-2 border rounded">
                            </div>
                        </div>

                        <!-- External Links Section -->
                        <div class="form-section">
                            <h4 class="form-section-title">External Links</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm text-gray-600 flex items-center space-x-1 mb-1">
                                        ${this.icon('Globe', 16)}
                                        <span>Company Website</span>
                                    </label>
                                    <input type="url" placeholder="https://example.com"
                                           value="${formData.website || ''}"
                                           onchange="app.updateFormField('website', this.value)"
                                           class="w-full p-2 border rounded"
                                           pattern="https?://.+">
                                </div>
                                
                                <div>
                                    <label class="text-sm text-gray-600 flex items-center space-x-1 mb-1">
                                        ${this.icon('LinkedIn', 16)}
                                        <span>LinkedIn Profile</span>
                                    </label>
                                    <input type="url" placeholder="https://linkedin.com/company/..."
                                           value="${formData.linkedIn || ''}"
                                           onchange="app.updateFormField('linkedIn', this.value)"
                                           class="w-full p-2 border rounded"
                                           pattern="https?://.+">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderOpportunityForm() {
                const formData = this.state.formData;
                
                return `
                    <div class="space-y-4">
                        <input type="text" placeholder="Opportunity Title"
                               value="${formData.title || ''}"
                               onchange="app.updateFormField('title', this.value)"
                               class="w-full p-2 border rounded">
                        
                        <select onchange="app.updateFormField('customerId', this.value)"
                                class="w-full p-2 border rounded">
                            <option value="">Select Customer</option>
                            ${this.state.customers.map(c => `
                                <option value="${c.id}" ${formData.customerId === c.id ? 'selected' : ''}>
                                    ${c.name}
                                </option>
                            `).join('')}
                        </select>
                        
                        <input type="number" placeholder="Value ($)"
                               value="${formData.value || ''}"
                               onchange="app.updateFormField('value', parseFloat(this.value) || '')"
                               class="w-full p-2 border rounded">
                        
                        <input type="date" placeholder="Expected Close Date"
                               value="${formData.expectedClose || ''}"
                               onchange="app.updateFormField('expectedClose', this.value)"
                               class="w-full p-2 border rounded">
                        
                        <div class="border-t pt-4">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox"
                                       ${formData.createActivity ? 'checked' : ''}
                                       onchange="app.updateFormField('createActivity', this.checked)"
                                       class="rounded">
                                <span class="text-sm font-medium">Create initial follow-up activity</span>
                            </label>
                            ${formData.createActivity ? `
                                <input type="date" placeholder="Activity Date"
                                       value="${formData.activityDate || ''}"
                                       onchange="app.updateFormField('activityDate', this.value)"
                                       class="w-full p-2 border rounded mt-2">
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            renderQuoteForm() {
                const formData = this.state.formData;
                
                return `
                    <div class="space-y-4">
                        <p class="text-gray-500">Quote form coming soon...</p>
                        <select onchange="app.updateFormField('customerId', this.value)"
                                class="w-full p-2 border rounded">
                            <option value="">Select Customer</option>
                            ${this.state.customers.map(c => `
                                <option value="${c.id}" ${formData.customerId === c.id ? 'selected' : ''}>
                                    ${c.name}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }

            renderActivityForm() {
                const formData = this.state.formData;
                
                return `
                    <div class="space-y-4">
                        <select onchange="app.updateFormField('type', this.value)"
                                class="w-full p-2 border rounded">
                            <option value="">Select Type</option>
                            <option value="call" ${formData.type === 'call' ? 'selected' : ''}>Call</option>
                            <option value="email" ${formData.type === 'email' ? 'selected' : ''}>Email</option>
                            <option value="meeting" ${formData.type === 'meeting' ? 'selected' : ''}>Meeting</option>
                        </select>
                        
                        <input type="text" placeholder="Subject"
                               value="${formData.subject || ''}"
                               onchange="app.updateFormField('subject', this.value)"
                               class="w-full p-2 border rounded">
                        
                        <select onchange="app.updateFormField('customerId', this.value)"
                                class="w-full p-2 border rounded">
                            <option value="">Select Customer</option>
                            ${this.state.customers.map(c => `
                                <option value="${c.id}" ${formData.customerId === c.id ? 'selected' : ''}>
                                    ${c.name}
                                </option>
                            `).join('')}
                        </select>
                        
                        ${formData.customerId ? `
                            <select onchange="app.updateFormField('opportunityId', this.value || null)"
                                    class="w-full p-2 border rounded">
                                <option value="">Link to Opportunity (Optional)</option>
                                ${this.state.opportunities
                                    .filter(o => o.customerId === formData.customerId)
                                    .map(o => `
                                        <option value="${o.id}" ${formData.opportunityId === o.id ? 'selected' : ''}>
                                            ${o.title}
                                        </option>
                                    `).join('')}
                            </select>
                        ` : ''}
                        
                        <input type="date"
                               value="${formData.date || ''}"
                               onchange="app.updateFormField('date', this.value)"
                               class="w-full p-2 border rounded">
                        
                        <input type="time"
                               value="${formData.time || ''}"
                               onchange="app.updateFormField('time', this.value)"
                               class="w-full p-2 border rounded">
                        
                        <textarea placeholder="Notes"
                                  value="${formData.notes || ''}"
                                  onchange="app.updateFormField('notes', this.value)"
                                  class="w-full p-2 border rounded"
                                  rows="3"></textarea>
                        
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-1">
                                Update Pipeline Stage (Optional)
                            </label>
                            <select onchange="app.updateFormField('pipelineStage', this.value)"
                                    class="w-full p-2 border rounded">
                                <option value="">Keep Current Stage</option>
                                ${this.customerStages.map(stage => `
                                    <option value="${stage.id}" ${formData.pipelineStage === stage.id ? 'selected' : ''}>
                                        ${stage.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                `;
            }

            renderFollowUpModal() {
                if (!this.state.showFollowUp) return '';
                
                const activity = this.state.showFollowUp;
                const customer = this.state.customers.find(c => c.id === activity.customerId);
                const currentStage = this.customerStages.find(s => s.id === customer?.pipelineStage);
                
                const getSuggestedActions = () => {
                    switch (customer?.pipelineStage) {
                        case 'quote_out':
                            return [
                                { subject: 'Follow up on quote', stage: 'negotiating' },
                                { subject: 'Check if quote was received', stage: 'quote_out' },
                                { subject: 'Discuss pricing adjustments', stage: 'negotiating' }
                            ];
                        case 'negotiating':
                            return [
                                { subject: 'Final pricing discussion', stage: 'po_pending' },
                                { subject: 'Address concerns', stage: 'negotiating' },
                                { subject: 'Send revised quote', stage: 'quote_out' }
                            ];
                        case 'po_pending':
                            return [
                                { subject: 'Check on PO status', stage: 'po_pending' },
                                { subject: 'Confirm PO received', stage: 'po_received' },
                                { subject: 'Follow up on approval process', stage: 'po_pending' }
                            ];
                        case 'po_received':
                            return [
                                { subject: 'Confirm delivery schedule', stage: 'fulfillment' },
                                { subject: 'Review order details', stage: 'po_received' },
                                { subject: 'Discuss shipping arrangements', stage: 'fulfillment' }
                            ];
                        default:
                            return [
                                { subject: 'Schedule follow-up call', stage: customer?.pipelineStage || 'lead' },
                                { subject: 'Send additional information', stage: customer?.pipelineStage || 'lead' }
                            ];
                    }
                };
                
                const suggestedActions = getSuggestedActions();
                
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeFollowUp()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-4 lg:p-6"
                             onclick="event.stopPropagation()">
                            <div class="mb-4">
                                <h3 class="text-lg lg:text-xl font-semibold">Create Follow-up Activity</h3>
                                <p class="text-sm text-gray-600 mt-1">
                                    Activity completed for ${customer?.name || 'Unknown'}
                                </p>
                                ${currentStage ? `
                                    <p class="text-sm mt-1">
                                        Current stage: <span class="px-2 py-1 text-xs rounded-full text-white ${currentStage.color}">
                                            ${currentStage.name}
                                        </span>
                                    </p>
                                ` : ''}
                            </div>
                            
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-2">Suggested Actions:</p>
                                <div class="space-y-2">
                                    ${suggestedActions.map((suggestion, idx) => `
                                        <button onclick="app.selectSuggestedAction('${suggestion.subject}', '${suggestion.stage}')"
                                                class="w-full text-left p-2 border rounded hover:bg-gray-50 text-sm">
                                            ${suggestion.subject}
                                            ${suggestion.stage !== customer?.pipelineStage ? `
                                                <span class="text-xs text-gray-500 ml-2">
                                                    → ${this.customerStages.find(s => s.id === suggestion.stage)?.name}
                                                </span>
                                            ` : ''}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700 block mb-1">Activity Type</label>
                                    <select id="followup-type" class="w-full p-2 border rounded">
                                        <option value="call">Call</option>
                                        <option value="email">Email</option>
                                        <option value="meeting">Meeting</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="text-sm font-medium text-gray-700 block mb-1">Subject</label>
                                    <input type="text" id="followup-subject"
                                           placeholder="What's the follow-up about?"
                                           class="w-full p-2 border rounded">
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-medium text-gray-700 block mb-1">Date</label>
                                        <input type="date" id="followup-date"
                                               value="${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}"
                                               class="w-full p-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-700 block mb-1">Time</label>
                                        <input type="text" id="followup-time"
                                               value="10:00 AM"
                                               placeholder="10:00 AM"
                                               class="w-full p-2 border rounded">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="text-sm font-medium text-gray-700 block mb-1">Update Pipeline Stage</label>
                                    <select id="followup-stage" class="w-full p-2 border rounded">
                                        <option value="">Keep Current Stage (${currentStage?.name})</option>
                                        ${this.customerStages.map(stage => `
                                            <option value="${stage.id}">${stage.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="text-sm font-medium text-gray-700 block mb-1">Notes</label>
                                    <textarea id="followup-notes"
                                              placeholder="Any additional notes..."
                                              class="w-full p-2 border rounded"
                                              rows="3"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button onclick="app.closeFollowUp()"
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                    Skip Follow-up
                                </button>
                                <button onclick="app.createFollowUpFromModal()"
                                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Create Follow-up
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderCustomerDetailsModal() {
                const customerId = this.state.viewingCustomerId;
                if (!customerId) return '';
                
                const customer = this.state.customers.find(c => c.id === customerId);
                if (!customer) return '';
                
                const stage = this.customerStages.find(s => s.id === customer.pipelineStage);
                const opportunities = this.state.opportunities.filter(o => o.customerId === customerId);
                const activities = this.state.activities.filter(a => a.customerId === customerId);
                const quotes = this.state.quotes.filter(q => q.customerId === customerId);
                
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeCustomerDetails()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto"
                             onclick="event.stopPropagation()">
                            <div class="sticky top-0 bg-white border-b p-4 lg:p-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-xl lg:text-2xl font-semibold">${customer.name}</h3>
                                        <div class="flex items-center space-x-2 mt-2">
                                            <span class="px-2 py-1 text-xs rounded-full ${
                                                customer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                            }">
                                                ${customer.status}
                                            </span>
                                            ${stage ? `
                                                <span class="px-2 py-1 text-xs rounded-full text-white ${stage.color}">
                                                    ${stage.name}
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <button onclick="app.closeCustomerDetails()" class="text-gray-500 hover:text-gray-700 p-1">
                                        ${this.icon('X', 24)}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-4 lg:p-6">
                                <!-- Basic Information -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <h4 class="font-semibold text-lg mb-4">Contact Information</h4>
                                        <div class="space-y-2">
                                            <p class="flex items-center space-x-2">
                                                ${this.icon('Users', 16, 'text-gray-400')}
                                                <span>${customer.contact || 'No contact specified'}</span>
                                            </p>
                                            <p class="flex items-center space-x-2">
                                                ${this.icon('Mail', 16, 'text-gray-400')}
                                                <a href="mailto:${customer.email}" class="text-blue-600 hover:underline">
                                                    ${customer.email}
                                                </a>
                                            </p>
                                            <p class="flex items-center space-x-2">
                                                ${this.icon('Phone', 16, 'text-gray-400')}
                                                <a href="tel:${customer.phone}" class="text-blue-600 hover:underline">
                                                    ${customer.phone}
                                                </a>
                                            </p>
                                            <p class="flex items-center space-x-2">
                                                ${this.icon('BarChart3', 16, 'text-gray-400')}
                                                <span>Industry: ${customer.industry || 'Not specified'}</span>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 class="font-semibold text-lg mb-4">External Links</h4>
                                        <div class="space-y-2">
                                            ${customer.website ? `
                                                <a href="${customer.website}" target="_blank" 
                                                   class="flex items-center space-x-2 text-blue-600 hover:underline">
                                                    ${this.icon('Globe', 16)}
                                                    <span>Company Website</span>
                                                </a>
                                            ` : `
                                                <p class="flex items-center space-x-2 text-gray-400">
                                                    ${this.icon('Globe', 16)}
                                                    <span>No website provided</span>
                                                </p>
                                            `}
                                            ${customer.linkedIn ? `
                                                <a href="${customer.linkedIn}" target="_blank" 
                                                   class="flex items-center space-x-2 text-blue-600 hover:underline">
                                                    ${this.icon('LinkedIn', 16)}
                                                    <span>LinkedIn Profile</span>
                                                </a>
                                            ` : `
                                                <p class="flex items-center space-x-2 text-gray-400">
                                                    ${this.icon('LinkedIn', 16)}
                                                    <span>No LinkedIn profile provided</span>
                                                </p>
                                            `}
                                        </div>
                                    </div>
                                </div>

                                <!-- Company Profile -->
                                ${(customer.companyBackground || customer.productsUsed || customer.decisionMakers || customer.budgetCycles) ? `
                                    <div class="mb-6">
                                        <h4 class="font-semibold text-lg mb-4">Company Profile</h4>
                                        <div class="space-y-4">
                                            ${customer.companyBackground ? `
                                                <div>
                                                    <h5 class="font-medium text-gray-700 mb-1">Background</h5>
                                                    <p class="text-gray-600">${customer.companyBackground}</p>
                                                </div>
                                            ` : ''}
                                            ${customer.productsUsed ? `
                                                <div>
                                                    <h5 class="font-medium text-gray-700 mb-1">Products They Use</h5>
                                                    <p class="text-gray-600">${customer.productsUsed}</p>
                                                </div>
                                            ` : ''}
                                            ${customer.decisionMakers ? `
                                                <div>
                                                    <h5 class="font-medium text-gray-700 mb-1">Decision Makers</h5>
                                                    <p class="text-gray-600">${customer.decisionMakers}</p>
                                                </div>
                                            ` : ''}
                                            ${customer.budgetCycles ? `
                                                <div>
                                                    <h5 class="font-medium text-gray-700 mb-1">Budget Cycles</h5>
                                                    <p class="text-gray-600">${customer.budgetCycles}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Business Preferences -->
                                ${(customer.deliveryPreferences || customer.paymentTerms) ? `
                                    <div class="mb-6">
                                        <h4 class="font-semibold text-lg mb-4">Business Preferences</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            ${customer.deliveryPreferences ? `
                                                <div>
                                                    <h5 class="font-medium text-gray-700 mb-1">Delivery Preferences</h5>
                                                    <p class="text-gray-600">${customer.deliveryPreferences}</p>
                                                </div>
                                            ` : ''}
                                            ${customer.paymentTerms ? `
                                                <div>
                                                    <h5 class="font-medium text-gray-700 mb-1">Payment Terms</h5>
                                                    <p class="text-gray-600">${customer.paymentTerms}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Related Data Tabs -->
                                <div class="border-t pt-6">
                                    <div class="flex space-x-4 mb-4 border-b">
                                        <button onclick="app.setCustomerDetailTab('opportunities')"
                                                class="pb-2 px-1 ${this.state.customerDetailTab === 'opportunities' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}">
                                            Opportunities (${opportunities.length})
                                        </button>
                                        <button onclick="app.setCustomerDetailTab('activities')"
                                                class="pb-2 px-1 ${this.state.customerDetailTab === 'activities' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}">
                                            Activities (${activities.length})
                                        </button>
                                        <button onclick="app.setCustomerDetailTab('quotes')"
                                                class="pb-2 px-1 ${this.state.customerDetailTab === 'quotes' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}">
                                            Quotes (${quotes.length})
                                        </button>
                                    </div>

                                    <div class="mt-4">
                                        ${this.state.customerDetailTab === 'opportunities' ? `
                                            <div class="space-y-3">
                                                ${opportunities.length === 0 ? `
                                                    <p class="text-gray-400">No opportunities yet</p>
                                                ` : opportunities.map(opp => {
                                                    const oppStage = this.pipelineStages.find(s => s.id === opp.stage);
                                                    return `
                                                        <div class="border rounded-lg p-4">
                                                            <div class="flex justify-between items-start">
                                                                <div>
                                                                    <h5 class="font-medium">${opp.title}</h5>
                                                                    <p class="text-sm text-gray-600 mt-1">
                                                                        ${oppStage?.name} • ${(opp.value || 0).toLocaleString()}
                                                                    </p>
                                                                    <p class="text-sm text-gray-500">
                                                                        Expected close: ${opp.expectedClose || 'Not set'}
                                                                    </p>
                                                                </div>
                                                                <button onclick="app.showOpportunityDetails('${opp.id}')"
                                                                        class="text-blue-600 hover:text-blue-800">
                                                                    ${this.icon('Eye', 16)}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        ` : this.state.customerDetailTab === 'activities' ? `
                                            <div class="space-y-3">
                                                ${activities.length === 0 ? `
                                                    <p class="text-gray-400">No activities yet</p>
                                                ` : activities
                                                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                                                    .map(activity => `
                                                        <div class="border rounded-lg p-4">
                                                            <div class="flex justify-between items-start">
                                                                <div>
                                                                    <h5 class="font-medium">${activity.subject}</h5>
                                                                    <p class="text-sm text-gray-600 mt-1">
                                                                        ${activity.type} • ${activity.date} at ${activity.time}
                                                                    </p>
                                                                    ${activity.notes ? `
                                                                        <p class="text-sm text-gray-500 mt-2">${activity.notes}</p>
                                                                    ` : ''}
                                                                </div>
                                                                <div>
                                                                    ${activity.completed ? 
                                                                        this.icon('Check', 16, 'text-green-500') : 
                                                                        this.icon('Clock', 16, 'text-yellow-500')
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                            </div>
                                        ` : `
                                            <div class="space-y-3">
                                                ${quotes.length === 0 ? `
                                                    <p class="text-gray-400">No quotes yet</p>
                                                ` : quotes.map(quote => `
                                                    <div class="border rounded-lg p-4">
                                                        <div class="flex justify-between items-start">
                                                            <div>
                                                                <h5 class="font-medium">${quote.quoteNumber}</h5>
                                                                <p class="text-sm text-gray-600 mt-1">
                                                                    Created: ${new Date(quote.createdAt).toLocaleDateString()}
                                                                </p>
                                                            </div>
                                                            <span class="px-2 py-1 text-xs rounded-full ${
                                                                quote.status === 'sent' ? 'bg-blue-100 text-blue-800' :
                                                                quote.status === 'accepted' ? 'bg-green-100 text-green-800' :
                                                                'bg-gray-100 text-gray-800'
                                                            }">
                                                                ${quote.status}
                                                            </span>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sticky bottom-0 bg-white border-t p-4 lg:p-6">
                                <div class="flex justify-end space-x-3">
                                    <button onclick="app.scheduleActivityForCustomer('${customerId}'); app.closeCustomerDetails();"
                                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                        Schedule Activity
                                    </button>
                                    <button onclick="app.editCustomer('${customerId}'); app.closeCustomerDetails();"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Edit Customer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            render() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="flex min-h-screen bg-gray-100">
                        ${this.renderNavigation()}
                        
                        <div class="flex-1 overflow-y-auto lg:ml-64">
                            <div class="lg:hidden h-20"></div>
                            ${this.renderActiveView()}
                        </div>
                        
                        ${this.renderModal()}
                        ${this.renderCustomerDetailsModal()}
                    </div>
                `;
            }

            renderActiveView() {
                switch(this.state.activeView) {
                    case 'dashboard':
                        return this.renderDashboard();
                    case 'customers':
                        return this.renderCustomers();
                    case 'pipeline':
                        return this.renderPipeline();
                    case 'quotes':
                        return this.renderQuotes();
                    case 'activities':
                        return this.renderActivities();
                    default:
                        return this.renderDashboard();
                }
            }

            // Event handlers
            setView(view) {
                this.state.activeView = view;
                this.state.mobileMenuOpen = false;
                this.closeModal();
                this.state.industryFilter = 'all';
                this.render();
            }

            toggleMobileMenu() {
                this.state.mobileMenuOpen = !this.state.mobileMenuOpen;
                this.render();
            }

            updateSearchTerm(value) {
                this.state.searchTerm = value;
                this.render();
            }

            updateIndustryFilter(value) {
                this.state.industryFilter = value;
                this.render();
            }

            updateActivityFilter(value) {
                this.state.activityFilter = value;
                this.render();
            }

            updateFormField(field, value) {
                this.state.formData[field] = value;
                if (field === 'industry' && value !== 'Other') {
                    delete this.state.formData.customIndustry;
                }
                this.render();
            }

            updateCharCount(field, value, maxLength) {
                const counter = document.getElementById(`${field}-counter`);
                if (counter) {
                    counter.textContent = `${value.length}/${maxLength}`;
                }
            }

            editCustomer(customerId) {
                const customer = this.state.customers.find(c => c.id === customerId);
                if (customer) {
                    this.state.editingCustomer = customer;
                    const isCustomIndustry = customer.industry && !INDUSTRIES.includes(customer.industry);
                    this.state.formData = {
                        name: customer.name,
                        industry: isCustomIndustry ? 'Other' : customer.industry || '',
                        customIndustry: isCustomIndustry ? customer.industry : '',
                        contact: customer.contact,
                        email: customer.email,
                        phone: customer.phone,
                        status: customer.status,
                        pipelineStage: customer.pipelineStage,
                        companyBackground: customer.companyBackground || '',
                        productsUsed: customer.productsUsed || '',
                        deliveryPreferences: customer.deliveryPreferences || '',
                        paymentTerms: customer.paymentTerms || '',
                        website: customer.website || '',
                        linkedIn: customer.linkedIn || '',
                        decisionMakers: customer.decisionMakers || '',
                        budgetCycles: customer.budgetCycles || ''
                    };
                    this.state.showModal = 'customer';
                    this.render();
                }
            }

            viewCustomerDetails(customerId) {
                this.state.viewingCustomerId = customerId;
                this.state.customerDetailTab = 'opportunities';
                this.render();
            }

            closeCustomerDetails() {
                this.state.viewingCustomerId = null;
                this.render();
            }

            setCustomerDetailTab(tab) {
                this.state.customerDetailTab = tab;
                this.render();
            }

            scheduleActivityForCustomer(customerId) {
                const customer = this.state.customers.find(c => c.id === customerId);
                if (customer) {
                    this.state.formData = {
                        customerId: customer.id,
                        type: 'call',
                        subject: `Follow up with ${customer.name}`,
                        date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: '10:00 AM',
                        notes: '',
                        pipelineStage: customer.pipelineStage || 'lead'
                    };
                    this.state.showModal = 'activity';
                    this.render();
                }
            }

            createActivityForOpportunity(oppId) {
                const opp = this.state.opportunities.find(o => o.id === oppId);
                if (opp) {
                    this.state.formData = {
                        customerId: opp.customerId,
                        opportunityId: opp.id,
                        subject: `Follow up: ${opp.title}`,
                        type: 'call',
                        date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: '10:00 AM',
                        notes: ''
                    };
                    this.state.showModal = 'activity';
                    this.render();
                }
            }

            handleModalSubmit() {
                switch(this.state.showModal) {
                    case 'customer':
                        if (this.state.editingCustomer) {
                            this.handleUpdateCustomer();
                        } else {
                            this.handleAddCustomer();
                        }
                        break;
                    case 'opportunity':
                        this.handleAddOpportunity();
                        break;
                    case 'quote':
                        this.handleAddQuote();
                        break;
                    case 'activity':
                        this.handleAddActivity();
                        break;
                }
            }

            showOpportunityDetails(oppId) {
                this.state.selectedOpp = this.state.opportunities.find(o => o.id === oppId);
                this.render();
            }

            closeOpportunityDetails() {
                this.state.selectedOpp = null;
                this.render();
            }

            handleDragStart(event, oppId) {
                event.dataTransfer.setData('opportunityId', oppId);
                event.target.classList.add('dragging');
            }

            handleDrop(event, newStage) {
                event.preventDefault();
                const oppId = event.dataTransfer.getData('opportunityId');
                const opportunity = this.state.opportunities.find(o => o.id === oppId);
                
                if (opportunity) {
                    opportunity.stage = newStage;
                    opportunity.updatedAt = new Date().toISOString();
                    
                    localStorage.setItem('opportunities', JSON.stringify(this.state.opportunities));
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`opportunities/${oppId}`).set(opportunity);
                    }
                    
                    this.render();
                }
                
                // Remove drag styling
                document.querySelectorAll('.dragging').forEach(el => {
                    el.classList.remove('dragging');
                });
            }

            markActivityComplete(activityId) {
                const activity = this.state.activities.find(a => a.id === activityId);
                if (activity) {
                    this.markActivityComplete(activity);
                }
            }

            closeFollowUp() {
                this.state.showFollowUp = null;
                this.render();
            }

            selectSuggestedAction(subject, stage) {
                document.getElementById('followup-subject').value = subject;
                document.getElementById('followup-stage').value = stage;
            }

            createFollowUpFromModal() {
                const followUpData = {
                    type: document.getElementById('followup-type').value,
                    subject: document.getElementById('followup-subject').value,
                    date: document.getElementById('followup-date').value,
                    time: document.getElementById('followup-time').value,
                    notes: document.getElementById('followup-notes').value,
                    pipelineStage: document.getElementById('followup-stage').value
                };
                
                if (!followUpData.subject) {
                    alert('Please enter a subject for the follow-up');
                    return;
                }
                
                this.createFollowUp(this.state.showFollowUp, followUpData);
            }
        }

        // Initialize the app
        const app = new MajorMetalsCRM();
        window.app = app;
    </script>
</body>
</html>
                                