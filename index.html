<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Major Metals CRM</title>
    
    <!-- Updated Content Security Policy with WebSocket support and additional Google domains -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval'
            https://cdn.tailwindcss.com
            https://www.gstatic.com/
            https://apis.google.com/
            https://accounts.google.com/
            https://www.googleapis.com/
            https://securetoken.googleapis.com/
            https://www.google.com/
            https://www.googletagmanager.com/;
        connect-src 'self'
            https://*.googleapis.com
            https://*.google.com
            https://*.firebaseio.com
            https://*.firebaseapp.com
            wss://*.firebaseio.com
            https://securetoken.googleapis.com/
            https://www.googleapis.com/
            https://accounts.google.com/;
        frame-src 
            https://accounts.google.com/ 
            https://apis.google.com/
            https://content.googleapis.com/
            https://www.google.com/
            https://securetoken.googleapis.com/
            https://*.firebaseapp.com;
        style-src 'self' 'unsafe-inline' 
            https://cdn.tailwindcss.com
            https://accounts.google.com/
            https://www.googleapis.com/;
        img-src 'self' data: https: blob: 
            https://*.googleusercontent.com
            https://*.google.com
            https://*.gstatic.com;
        font-src 'self' data: 
            https://fonts.gstatic.com;
    ">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mobile-specific optimizations */
        @media (max-width: 1024px) {
            button, a, input, select, textarea {
                min-height: 44px;
            }
            
            * {
                -webkit-overflow-scrolling: touch;
            }
            
            .safe-top {
                padding-top: env(safe-area-inset-top);
            }
            
            .safe-bottom {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            button, nav {
                -webkit-user-select: none;
                user-select: none;
            }
            
            input, select, textarea {
                font-size: 16px;
            }
        }
        
        @supports (height: 100dvh) {
            .min-h-screen {
                min-height: 100dvh;
            }
        }

        /* Form sections styling */
        .form-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .form-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #374151;
        }

        /* Character counter styling */
        .char-counter {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
            margin-top: 0.25rem;
        }

        /* URL input validation */
        input[type="url"]:invalid {
            border-color: #ef4444;
        }

        input[type="url"]:valid {
            border-color: #10b981;
        }

        /* Drag and drop styles */
        .dragging {
            opacity: 0.5;
        }

        /* Recording animation */
        .recording {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        /* Checkbox styles */
        .bulk-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Product tag */
        .product-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin: 0.125rem;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Google Identity Services for new auth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google API Script for Calendar API -->
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        // Firebase configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCKIKzPH6ibixe7rnq0em4AAsdq5b10WDA",
            authDomain: "crm-mm-7bdfb.firebaseapp.com",
            databaseURL: "https://crm-mm-7bdfb-default-rtdb.firebaseio.com",
            projectId: "crm-mm-7bdfb",
            storageBucket: "crm-mm-7bdfb.firebasestorage.app",
            messagingSenderId: "321138365753",
            appId: "1:321138365753:web:866da9cdc5a300219944e8"
        };

        // Google Calendar configuration
        const GOOGLE_CONFIG = {
            clientId: '321138365753-d9gndqf1mliep73f58g36p0hvj21frcp.apps.googleusercontent.com',
            apiKey: 'AIzaSyBFsW2Snv1c9OBcgh5P70KAEZ1JGYK_uXE',
            scope: 'https://www.googleapis.com/auth/calendar.events',
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
        };

        // Industries list
        const INDUSTRIES = [
            "Access Flooring", "Agriculture", "Association / Trade Group", "Automotive", 
            "Basement Columns", "Carport / Metal Buildings", "Carports", "Chair Lifts", 
            "Containers (IBC)", "Conveyor", "DOT Manufacturing", "Defense Contractor", 
            "Distributor", "Engineered Cabs", "Equipment", "Fabric Structures / Hoop Buildings", 
            "Fabrication", "Fans & Fans Racks Manufacturing", "Fencing", "Fitness Equipment", 
            "Furniture", "Highway", "Highway, Rail", "ISO Intermodal Containers", "Ladder", 
            "Lawn & Garden", "Manufacturer", "Metal Buildings", "Metal Buildings / Carports", 
            "Metal Stamping", "Mezzanines", "Mobile Housing", "RV", "Racking - Automotive", 
            "Racking - Computer Servers", "Racking - Servers", "Racking / Storage", "Racks", 
            "Roll Former", "Roll Off / Dumpster", "Rollforming", "Scaffolding", "Service center", 
            "Signpost", "Solar", "Steel buildings", "Storage / Racking", 
            "Structural Steel Fabrication", "Tension Fabric Buildings", "Tire Racks", 
            "Trailers", "Truck Equipment", "Tubular Wire Carriers", "Other"
        ];

        // Products list
        const PRODUCTS = [
            "Square Tubing - 1x1", "Square Tubing - 1.5x1.5", "Square Tubing - 2x2", 
            "Square Tubing - 2.5x2.5", "Square Tubing - 3x3", "Square Tubing - 4x4",
            "Rectangle Tubing - 2x1", "Rectangle Tubing - 3x2", "Rectangle Tubing - 4x2",
            "Rectangle Tubing - 4x3", "Rectangle Tubing - 6x2", "Rectangle Tubing - 6x4",
            "Round Pipe - 1 inch", "Round Pipe - 1.5 inch", "Round Pipe - 2 inch",
            "Round Pipe - 2.5 inch", "Round Pipe - 3 inch", "Round Pipe - 4 inch", 
            "Custom Size Tube",
            "Custom Cut-to-Length", 
            "Galvanized", "HR", "HRPO", "Gavaneal", "CR",
            "Other"
        ];

        // Contact methods
        const CONTACT_METHODS = ["Phone", "Email", "Text/SMS", "In-Person", "Any"];

        // Main CRM Application Class
        class MajorMetalsCRM {
            constructor() {
            this.tokenClient = null;
            this.accessToken = null;
            // ... rest of your existing constructor code
            this.state = {
                activeView: 'dashboard',
                customers: [],
                opportunities: [],
                quotes: [],
                activities: [],
                showModal: null,
                formData: {},
                searchTerm: '',
                globalSearchTerm: '',
                globalSearchResults: null,
                activityFilter: 'all',
                industryFilter: 'all',
                pipelineFilter: 'all',
                statusFilter: 'all',
                showFollowUp: null,
                isOnline: navigator.onLine,
                isSyncing: false,
                lastSync: null,
                firebaseDb: null,
                firebaseStorage: null,
                isFirebaseConfigured: false,
                editingCustomer: null,
                mobileMenuOpen: false,
                selectedOpp: null,
                editingActivity: null,
                viewingActivity: null,
                uploadingFile: false,
                bulkMode: false,
                selectedItems: new Set(),
                isRecording: false,
                mediaRecorder: null,
                audioChunks: [],
                recordingTime: 0,
                recordingTimer: null,
                googleCalendarConnected: false,
                showCompletedActivities: false,
                customerDetailTab: 'opportunities',
                viewingCustomerId: null
            };

                this.customerStages = [
                    { id: 'lead', name: 'Lead', color: 'bg-gray-500' },
                    { id: 'qualified', name: 'Qualified', color: 'bg-blue-500' },
                    { id: 'quote_out', name: 'Quote Out', color: 'bg-purple-500' },
                    { id: 'negotiating', name: 'Negotiating', color: 'bg-yellow-500' },
                    { id: 'po_pending', name: 'PO Pending', color: 'bg-orange-500' },
                    { id: 'po_received', name: 'PO Received', color: 'bg-green-500' },
                    { id: 'fulfillment', name: 'In Fulfillment', color: 'bg-indigo-500' },
                    { id: 'delivered', name: 'Delivered', color: 'bg-teal-500' }
                ];

                this.pipelineStages = [
                    { id: 'new', name: 'New Lead', color: 'bg-gray-500' },
                    { id: 'qualified', name: 'Qualified', color: 'bg-blue-500' },
                    { id: 'quoted', name: 'Quoted', color: 'bg-purple-500' },
                    { id: 'negotiation', name: 'Negotiation', color: 'bg-yellow-500' },
                    { id: 'won', name: 'Won', color: 'bg-green-500' },
                    { id: 'lost', name: 'Lost', color: 'bg-red-500' }
                ];

                this.init();
            }

            async init() {
                this.loadFromLocalStorage();
                await this.setupFirebase();
                this.setupEventListeners();
                await this.initGoogleCalendar();
                this.render();
            }

            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.state.isOnline = true;
                    this.render();
                });
                window.addEventListener('offline', () => {
                    this.state.isOnline = false;
                    this.render();
                });

                // Handle global errors
                window.addEventListener('error', (e) => {
                    console.error('Global error:', e);
                });
            }

            async setupFirebase() {
                if (FIREBASE_CONFIG.apiKey !== "YOUR-API-KEY") {
                    this.state.isFirebaseConfigured = true;
                    
                    try {
                        await this.loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
                        await this.loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js');
                        await this.loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js');
                        
                        if (window.firebase) {
                            window.firebase.initializeApp(FIREBASE_CONFIG);
                            this.state.firebaseDb = window.firebase.database();
                            this.state.firebaseStorage = window.firebase.storage();
                            this.setupFirebaseListeners();
                        }
                    } catch (error) {
                        console.error('Error loading Firebase:', error);
                        this.state.isFirebaseConfigured = false;
                    }
                }
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

// Replace the initGoogleCalendar function
async initGoogleCalendar() {
    console.log('Initializing Google Calendar integration...');
    
    if (!GOOGLE_CONFIG.clientId || GOOGLE_CONFIG.clientId.includes('YOUR_GOOGLE_CLIENT_ID')) {
        console.log('Google Calendar integration not configured');
        return;
    }

    // Wait for both Google Identity Services and Google API to load
    if (!window.google || !window.google.accounts || !window.gapi) {
        console.log('Waiting for Google libraries to load...');
        setTimeout(() => this.initGoogleCalendar(), 500);
        return;
    }

    try {
        // Initialize the tokenClient for the new auth flow
        this.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CONFIG.clientId,
            scope: GOOGLE_CONFIG.scope,
            callback: async (response) => {
                console.log('Token callback received:', response);
                
                if (response.error) {
                    console.error('Token error:', response);
                    alert(`Authentication error: ${response.error}`);
                    return;
                }
                
                if (!response.access_token) {
                    console.error('No access token received');
                    alert('Authentication failed: No access token received');
                    return;
                }
                
                // Store the access token
                this.accessToken = response.access_token;
                console.log('Access token stored successfully');
                
                // Store in localStorage for persistence
                localStorage.setItem('googleAccessToken', response.access_token);
                localStorage.setItem('googleCalendarConnected', 'true');
                
                // Set the token for the API client
                gapi.client.setToken({
                    access_token: response.access_token
                });
                
                // Try to set connected status immediately to update UI
                this.state.googleCalendarConnected = true;
                this.render();
                
                // Then load the calendar API
                try {
                    console.log('Loading Google Calendar API...');
                    // Try loading without discovery docs first
                    gapi.client.setApiKey(GOOGLE_CONFIG.apiKey);
                    
                    // Load the calendar API v3
                    await new Promise((resolve, reject) => {
                        gapi.client.load('calendar', 'v3', (error) => {
                            if (error) {
                                console.error('Error in load callback:', error);
                                reject(error);
                            } else {
                                console.log('Calendar API v3 loaded via callback');
                                resolve();
                            }
                        });
                    });
                    
                    console.log('Google Calendar API loaded successfully');
                    
                    // Test the connection by making a simple API call
                    try {
                        console.log('Testing calendar access...');
                        const testResponse = await gapi.client.request({
                            path: 'https://www.googleapis.com/calendar/v3/users/me/settings/timezone',
                            method: 'GET',
                            headers: {
                                'Authorization': 'Bearer ' + response.access_token
                            }
                        });
                        console.log('Calendar access verified - timezone:', testResponse.result);
                        
                        // Show success message
                        alert('Successfully connected to Google Calendar!');
                    } catch (testError) {
                        console.error('Calendar access test failed:', testError);
                        // Don't fail the whole connection if just the test fails
                        console.log('Connection may still work for creating events');
                    }
                    
                } catch (error) {
                    console.error('Error loading Calendar API:', error);
                    
                    // Try alternative approach without API key
                    try {
                        console.log('Trying alternative Calendar API loading method...');
                        await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest');
                        console.log('Calendar API loaded via discovery URL');
                    } catch (altError) {
                        console.error('Alternative loading also failed:', altError);
                        // Don't disconnect - calendar operations might still work
                        console.log('Calendar API loading failed, but auth token is valid. Operations may still work.');
                    }
                }
            },
            error_callback: (error) => {
                console.error('OAuth error:', error);
                alert(`Authentication failed: ${error.type || 'Unknown error'}`);
            }
        });

        console.log('Token client initialized');

        // Load and initialize the Google API client library
        return new Promise((resolve) => {
            if (gapi.client) {
                console.log('Google API client already loaded');
                resolve();
                return;
            }
            
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_CONFIG.apiKey
                    });
                    console.log('Google API client initialized');
                    resolve();
                } catch (error) {
                    console.error('Error initializing Google API client:', error);
                    resolve();
                }
            });
        });
    } catch (error) {
        console.error('Error in initGoogleCalendar:', error);
        alert('Failed to initialize Google Calendar integration');
    }
}

// Replace the connectGoogleCalendar function
async connectGoogleCalendar() {
    if (!this.tokenClient) {
        alert('Google Calendar integration is not properly configured.');
        return;
    }

    try {
        // Request an access token
        this.tokenClient.requestAccessToken({prompt: 'consent'});
    } catch (error) {
        console.error('Error requesting access token:', error);
        alert('Failed to connect to Google Calendar. Please try again.');
    }
}

// Replace the disconnectGoogleCalendar function
async disconnectGoogleCalendar() {
    if (this.accessToken) {
        google.accounts.oauth2.revoke(this.accessToken, () => {
            this.accessToken = null;
            this.state.googleCalendarConnected = false;
            console.log('Disconnected from Google Calendar');
            this.render();
        });
    }
}

    // This is the ENHANCED addToGoogleCalendar function with all the new features:
async addToGoogleCalendar(activity) {
    if (!this.state.googleCalendarConnected || !this.accessToken) {
        if (confirm('Connect to Google Calendar to sync this activity?')) {
            await this.connectGoogleCalendar();
            // Wait a bit for the connection to complete
            setTimeout(() => {
                if (this.state.googleCalendarConnected) {
                    this.addToGoogleCalendar(activity);
                }
            }, 1000);
            return;
        } else {
            return;
        }
    }

    // Ensure the Calendar API is loaded
    if (!gapi.client.calendar) {
        try {
            await gapi.client.load('calendar', 'v3');
        } catch (error) {
            console.error('Error loading Calendar API:', error);
            alert('Failed to load Google Calendar API. Please try reconnecting.');
            return;
        }
    }

    // Set the access token for the API client
    gapi.client.setToken({
        access_token: this.accessToken
    });

    const customer = this.state.customers.find(c => c.id === activity.customerId);
    const opportunity = activity.opportunityId ? 
        this.state.opportunities.find(o => o.id === activity.opportunityId) : null;

    // Convert time to RFC3339 format
    const startTime = this.convertTo24Hour(activity.time);
    const endTime = this.addHour(startTime);

    // Get user's timezone
    const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    // Build rich description with all relevant CRM information
    let description = '';
    
    // Add activity notes if present
    if (activity.notes) {
        description += `📝 Notes:\n${activity.notes}\n\n`;
    }
    
    // Add customer details section
    description += '👤 Customer Information:\n';
    description += `• Company: ${customer?.name || 'Unknown'}\n`;
    description += `• Contact: ${customer?.contact || 'N/A'}\n`;
    description += `• Email: ${customer?.email || 'N/A'}\n`;
    description += `• Phone: ${customer?.phone || 'N/A'}\n`;
    description += `• Industry: ${customer?.industry || 'N/A'}\n`;
    
    // Add preferred contact method if available
    if (customer?.preferredContact) {
        description += `• Preferred Contact: ${customer.preferredContact}\n`;
    }
    
    // Add products of interest if available
    if (customer?.primaryProducts && customer.primaryProducts.length > 0) {
        description += `• Products of Interest: ${customer.primaryProducts.join(', ')}\n`;
    }
    
    // Add opportunity details if linked
    if (opportunity) {
        description += `\n💰 Opportunity Details:\n`;
        description += `• Title: ${opportunity.title}\n`;
        description += `• Value: $${(opportunity.value || 0).toLocaleString()}\n`;
        description += `• Stage: ${this.pipelineStages.find(s => s.id === opportunity.stage)?.name || opportunity.stage}\n`;
        description += `• Expected Close: ${opportunity.expectedClose || 'Not set'}\n`;
    }
    
    // Add activity metadata
    description += `\n📅 Activity Details:\n`;
    description += `• Type: ${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}\n`;
    description += `• Pipeline Stage: ${this.customerStages.find(s => s.id === activity.pipelineStage)?.name || activity.pipelineStage}\n`;
    
    // Add footer
    description += '\n---\n🔧 Created from Major Metals CRM';

    // Map CRM activity fields to Google Calendar event fields
    const event = {
        // 'summary' is the event title in Google Calendar - NOW includes customer name
        summary: `${activity.subject} - ${customer?.name || 'Unknown Customer'}`,
        
        // 'description' is the event body/notes with rich formatting
        description: description,
        
        // Location - add company address if available, otherwise company name
        location: customer?.address || customer?.name || '',
        
        // Start and end times
        start: {
            dateTime: `${activity.date}T${startTime}:00`,
            timeZone: timeZone
        },
        end: {
            dateTime: `${activity.date}T${endTime}:00`,
            timeZone: timeZone
        },
        
        // Set reminders based on activity type
        reminders: {
            useDefault: false,
            overrides: activity.type === 'meeting' ? [
                {method: 'popup', minutes: 60},
                {method: 'email', minutes: 1440} // 24 hours
            ] : [
                {method: 'popup', minutes: 30},
                {method: 'email', minutes: 60}
            ]
        },
        
        // Add attendees if we have customer email
        attendees: customer?.email ? [
            {
                email: customer.email, 
                displayName: customer.contact || customer.name,
                optional: false  // Make them required attendee
            }
        ] : [],
        
        // Color coding based on activity type
        // Google Calendar color IDs: https://developers.google.com/calendar/api/v3/reference/colors
        colorId: activity.type === 'call' ? '2' : // Bold green for calls
                 activity.type === 'meeting' ? '5' : // Bold yellow for meetings  
                 activity.type === 'email' ? '7' : // Bold blue for emails
                 '1', // Default blue for others
        
        // Add conference data for meetings if needed
        conferenceData: activity.type === 'meeting' ? {
            createRequest: {
                requestId: `crm-${activity.id}`,
                conferenceSolutionKey: {
                    type: 'hangoutsMeet'
                }
            }
        } : undefined
    };

    // Include conference data in the request if it's a meeting
    const requestParams = {
        calendarId: 'primary',
        resource: event
    };
    
    if (activity.type === 'meeting') {
        requestParams.conferenceDataVersion = 1;
    }

    try {
        const response = await gapi.client.calendar.events.insert(requestParams);

        if (response.status === 200 || response.result) {
            activity.googleCalendarId = response.result.id;
            activity.googleCalendarLink = response.result.htmlLink;
            
            // Store conference link if created
            if (response.result.conferenceData && response.result.conferenceData.entryPoints) {
                activity.meetingLink = response.result.conferenceData.entryPoints[0].uri;
            }
            
            this.saveAllToLocalStorage();
            
            if (this.state.firebaseDb && this.state.isOnline) {
                await this.state.firebaseDb.ref(`activities/${activity.id}`).set(activity);
            }

            alert('Activity added to Google Calendar!');
            this.render();
        } else {
            throw new Error('Failed to create calendar event');
        }
    } catch (error) {
        console.error('Error adding to Google Calendar:', error);
        if (error.status === 401) {
            // Token expired, need to re-authenticate
            this.state.googleCalendarConnected = false;
            this.accessToken = null;
            alert('Your Google session has expired. Please reconnect.');
            await this.connectGoogleCalendar();
        } else if (error.status === 403) {
            alert('Permission denied. Please make sure you have granted calendar access.');
        } else {
            alert('Failed to add activity to Google Calendar. Error: ' + (error.message || 'Unknown error'));
        }
    }
}

// Move these methods out as class methods
convertTo24Hour(time12h) {
    const [time, modifier] = time12h.split(' ');
    let [hours, minutes] = time.split(':');
    if (hours === '12') {
        hours = '00';
    }
    if (modifier === 'PM') {
        hours = parseInt(hours, 10) + 12;
    }
    return `${hours.toString().padStart(2, '0')}:${minutes}`;
}

addHour(time24h) {
    let [hours, minutes] = time24h.split(':');
    hours = (parseInt(hours, 10) + 1) % 24;
    return `${hours.toString().padStart(2, '0')}:${minutes}`;
}

            loadFromLocalStorage() {
                try {
                    const customers = JSON.parse(localStorage.getItem('customers') || '[]');
                    const opportunities = JSON.parse(localStorage.getItem('opportunities') || '[]');
                    const quotes = JSON.parse(localStorage.getItem('quotes') || '[]');
                    const activities = JSON.parse(localStorage.getItem('activities') || '[]');

                    if (customers.length === 0 && opportunities.length === 0 && activities.length === 0) {
                        // Initialize with sample data
                        this.state.customers = [
                            {
                                id: '1',
                                name: 'Apex Construction Inc.',
                                industry: 'Metal Buildings',
                                contact: 'John Davidson',
                                email: 'john@apexconstruction.com',
                                phone: '(555) 123-4567',
                                status: 'active',
                                pipelineStage: 'quote_out',
                                companyBackground: 'Leading construction company specializing in commercial metal buildings. Founded in 1995, serving the tri-state area.',
                                productsUsed: 'Square tubing (2x2, 3x3), Round pipes (various diameters), Galvanized steel sheets',
                                primaryProducts: ['Square Tubing - 2x2', 'Square Tubing - 3x3', 'Galvanized Products'],
                                deliveryPreferences: 'Job site delivery required, 48-hour notice preferred',
                                paymentTerms: 'Net 30, 2% discount for early payment',
                                website: 'https://www.apexconstruction.com',
                                linkedIn: 'https://linkedin.com/company/apex-construction-inc',
                                decisionMakers: 'John Davidson (Owner), Sarah Miller (Procurement Manager), Mike Chen (Project Manager)',
                                budgetCycles: 'Annual budget set in Q4, project-based purchasing throughout year',
                                preferredContact: 'Phone',
                                lastActivity: new Date().toISOString(),
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            }
                        ];

                        this.state.opportunities = [
                            {
                                id: '1',
                                customerId: '1',
                                title: 'Q1 2025 Bulk Order',
                                value: 125000,
                                stage: 'negotiation',
                                salesRep: 'Kaleb Smith',
                                expectedClose: '2025-03-31',
                                createdAt: new Date().toISOString()
                            }
                        ];

                        this.state.activities = [
                            {
                                id: '1',
                                customerId: '1',
                                type: 'email',
                                subject: 'Quote sent for Q1 order',
                                date: new Date().toISOString().split('T')[0],
                                time: '2:00 PM',
                                notes: 'Sent detailed quote with volume pricing. Customer seemed interested in the bulk discount options.',
                                completed: true,
                                pipelineStage: 'quote_out',
                                createdAt: new Date().toISOString()
                            }
                        ];

                        this.state.quotes = [];
                        this.saveAllToLocalStorage();
                    } else {
                        this.state.customers = customers;
                        this.state.opportunities = opportunities;
                        this.state.quotes = quotes;
                        this.state.activities = activities;
                    }
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
            }

            saveAllToLocalStorage() {
                try {
                    localStorage.setItem('customers', JSON.stringify(this.state.customers));
                    localStorage.setItem('opportunities', JSON.stringify(this.state.opportunities));
                    localStorage.setItem('quotes', JSON.stringify(this.state.quotes));
                    localStorage.setItem('activities', JSON.stringify(this.state.activities));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
            }

            setupFirebaseListeners() {
                const db = this.state.firebaseDb;
                let isInitialLoad = true;

                ['customers', 'opportunities', 'activities', 'quotes'].forEach(collection => {
                    db.ref(collection).on('value', (snapshot) => {
                        const data = snapshot.val();
                        const localData = this.state[collection];

                        if (!data && localData.length > 0 && isInitialLoad) {
                            const dataObj = {};
                            localData.forEach(item => {
                                dataObj[item.id] = item;
                            });
                            db.ref(collection).set(dataObj);
                            return;
                        }

                        if (data && !isInitialLoad) {
                            const dataArray = Object.entries(data).map(([id, item]) => ({
                                ...item,
                                id: id
                            }));
                            this.state[collection] = dataArray;
                            localStorage.setItem(collection, JSON.stringify(dataArray));
                            this.render();
                        }
                    });
                });

                setTimeout(() => {
                    isInitialLoad = false;
                    this.state.lastSync = new Date().toISOString();
                }, 2000);
            }

            // Icon components
            icon(name, size = 20, className = "") {
                const icons = {
                    Search: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>`,
                    Plus: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>`,
                    Phone: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>`,
                    Mail: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>`,
                    Calendar: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>`,
                    FileText: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>`,
                    BarChart3: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>`,
                    Users: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>`,
                    Package: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>`,
                    DollarSign: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>`,
                    TrendingUp: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>`,
                    Eye: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>`,
                    Edit2: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                    </svg>`,
                    Trash2: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>`,
                    Check: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>`,
                    X: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>`,
                    Clock: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>`,
                    AlertCircle: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>`,
                    Cloud: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                    </svg>`,
                    CloudOff: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>`,
                    RefreshCw: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>`,
                    Menu: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>`,
                    Globe: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>`,
                    LinkedIn: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                        <rect x="2" y="9" width="4" height="12"></rect>
                        <circle cx="4" cy="4" r="2"></circle>
                    </svg>`,
                    Mic: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>`,
                    MicOff: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                        <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>
                        <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>`,
                    Copy: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>`,
                    Square: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    </svg>`,
                    CheckSquare: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <polyline points="9 11 12 14 22 4"></polyline>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>`,
                    Paperclip: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                    </svg>`,
                    Upload: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>`,
                    Download: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${className}">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>`
                };
                return icons[name] || '';
            }

            // Metrics calculation
            getMetrics() {
                const openOpportunities = this.state.opportunities.filter(o => o.stage !== 'won' && o.stage !== 'lost');
                return {
                    openOpportunities: openOpportunities.length,
                    totalPipeline: openOpportunities.reduce((sum, o) => sum + (o.value || 0), 0),
                    wonDeals: this.state.opportunities.filter(o => o.stage === 'won').reduce((sum, o) => sum + (o.value || 0), 0),
                    activeCustomers: this.state.customers.filter(c => c.status === 'active').length,
                    winRate: this.state.opportunities.length > 0 
                        ? Math.round((this.state.opportunities.filter(o => o.stage === 'won').length / this.state.opportunities.length) * 100)
                        : 0
                };
            }

            // Global Search
            updateGlobalSearch(term) {
                this.state.globalSearchTerm = term;
                if (term.length >= 3) {
                    this.performGlobalSearch();
                } else {
                    this.state.globalSearchResults = null;
                }
                this.render();
            }

            performGlobalSearch() {
                const term = this.state.globalSearchTerm.toLowerCase();
                const results = {
                    customers: this.state.customers.filter(c => 
                        c.name?.toLowerCase().includes(term) ||
                        c.contact?.toLowerCase().includes(term) ||
                        c.email?.toLowerCase().includes(term) ||
                        c.primaryProducts?.some(p => p.toLowerCase().includes(term))
                    ),
                    activities: this.state.activities.filter(a => 
                        a.subject?.toLowerCase().includes(term) ||
                        a.notes?.toLowerCase().includes(term)
                    ),
                    opportunities: this.state.opportunities.filter(o => 
                        o.title?.toLowerCase().includes(term)
                    ),
                    quotes: this.state.quotes.filter(q => 
                        q.quoteName?.toLowerCase().includes(term) ||
                        q.quoteNumber?.toLowerCase().includes(term)
                    )
                };

                this.state.globalSearchResults = results;
            }

            // Bulk Operations
            toggleBulkMode() {
                this.state.bulkMode = !this.state.bulkMode;
                this.state.selectedItems.clear();
                this.render();
            }

            toggleSelectItem(id) {
                if (this.state.selectedItems.has(id)) {
                    this.state.selectedItems.delete(id);
                } else {
                    this.state.selectedItems.add(id);
                }
                this.render();
            }

            selectAllItems(items) {
                if (this.state.selectedItems.size === items.length) {
                    this.state.selectedItems.clear();
                } else {
                    items.forEach(item => this.state.selectedItems.add(item.id));
                }
                this.render();
            }

            executeBulkAction() {
                const action = document.getElementById('bulk-action-select')?.value;
                if (!action || this.state.selectedItems.size === 0) {
                    alert('Please select items and an action');
                    return;
                }

                switch (action) {
                    case 'update-stage':
                        this.showBulkUpdateModal('stage');
                        break;
                    case 'update-status':
                        this.showBulkUpdateModal('status');
                        break;
                    case 'delete':
                        this.bulkDelete();
                        break;
                    case 'export':
                        this.exportSelected();
                        break;
                }
            }

            showBulkUpdateModal(type) {
                this.state.showModal = `bulk-${type}`;
                this.render();
            }

            async bulkUpdateStage(stage) {
                const selectedIds = Array.from(this.state.selectedItems);
                
                for (const id of selectedIds) {
                    const customer = this.state.customers.find(c => c.id === id);
                    if (customer) {
                        customer.pipelineStage = stage;
                        customer.updatedAt = new Date().toISOString();
                    }
                }

                this.saveAllToLocalStorage();
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    for (const id of selectedIds) {
                        const customer = this.state.customers.find(c => c.id === id);
                        if (customer) {
                            await this.state.firebaseDb.ref(`customers/${id}`).set(customer);
                        }
                    }
                }

                this.state.bulkMode = false;
                this.state.selectedItems.clear();
                this.closeModal();
            }

            async bulkDelete() {
                if (!confirm(`Delete ${this.state.selectedItems.size} customers?`)) return;

                const selectedIds = Array.from(this.state.selectedItems);
                
                this.state.customers = this.state.customers.filter(c => !selectedIds.includes(c.id));
                this.saveAllToLocalStorage();
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    for (const id of selectedIds) {
                        await this.state.firebaseDb.ref(`customers/${id}`).remove();
                    }
                }

                this.state.bulkMode = false;
                this.state.selectedItems.clear();
                this.render();
            }

            exportSelected() {
                const selectedCustomers = this.state.customers.filter(c => 
                    this.state.selectedItems.has(c.id)
                );

                const csv = this.convertToCSV(selectedCustomers);
                this.downloadCSV(csv, 'customers_export.csv');
                
                this.state.bulkMode = false;
                this.state.selectedItems.clear();
                this.render();
            }

            convertToCSV(data) {
                const headers = ['Name', 'Industry', 'Contact', 'Email', 'Phone', 'Status', 'Products'];
                const rows = data.map(item => [
                    item.name,
                    item.industry || '',
                    item.contact || '',
                    item.email || '',
                    item.phone || '',
                    item.status || '',
                    (item.primaryProducts || []).join('; ')
                ]);

                return [headers, ...rows]
                    .map(row => row.map(cell => `"${cell}"`).join(','))
                    .join('\n');
            }

            downloadCSV(csv, filename) {
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            // Audio Recording
            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        } 
                    });
                    
                    // Determine the best MIME type
                    const mimeTypes = [
                        'audio/webm;codecs=opus',
                        'audio/webm',
                        'audio/mp4',
                        'audio/ogg;codecs=opus'
                    ];
                    
                    let selectedMimeType = '';
                    for (const mimeType of mimeTypes) {
                        if (MediaRecorder.isTypeSupported(mimeType)) {
                            selectedMimeType = mimeType;
                            break;
                        }
                    }
                    
                    if (!selectedMimeType) {
                        throw new Error('No supported audio format found');
                    }
                    
                    this.state.audioMimeType = selectedMimeType;
                    this.state.mediaRecorder = new MediaRecorder(stream, { 
                        mimeType: selectedMimeType 
                    });
                    this.state.audioChunks = [];
                    this.state.recordingTime = 0;
                    this.state.isRecording = true;
                    
                    this.state.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.state.audioChunks.push(event.data);
                        }
                    };
                    
                    this.state.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(this.state.audioChunks, { 
                            type: this.state.audioMimeType 
                        });
                        
                        // Stop all tracks to release microphone
                        stream.getTracks().forEach(track => track.stop());
                        
                        await this.saveAudioRecording(audioBlob);
                        this.render();
                    };
                    
                    this.state.mediaRecorder.start();
                    
                    // Start timer
                    this.state.recordingTimer = setInterval(() => {
                        this.state.recordingTime++;
                        const minutes = Math.floor(this.state.recordingTime / 60);
                        const seconds = this.state.recordingTime % 60;
                        const timeElement = document.getElementById('recording-time');
                        if (timeElement) {
                            timeElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        }
                    }, 1000);
                    
                    this.render();
                } catch (error) {
                    console.error('Error starting recording:', error);
                    if (error.name === 'NotAllowedError') {
                        alert('Microphone access denied. Please allow microphone access and try again.');
                    } else if (error.name === 'NotFoundError') {
                        alert('No microphone found. Please connect a microphone and try again.');
                    } else {
                        alert('Error starting recording: ' + error.message);
                    }
                }
            }

            stopRecording() {
                if (this.state.mediaRecorder && this.state.isRecording) {
                    this.state.mediaRecorder.stop();
                    this.state.isRecording = false;
                    
                    if (this.state.recordingTimer) {
                        clearInterval(this.state.recordingTimer);
                        this.state.recordingTimer = null;
                    }
                    
                    this.render();
                }
            }
            async saveAudioRecording(audioBlob) {
                if (!this.state.firebaseStorage || !this.state.isOnline) {
                    // Save to local state temporarily
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        this.state.formData.audioRecording = {
                            localData: reader.result,
                            duration: this.state.recordingTime,
                            recordedAt: new Date().toISOString(),
                            mimeType: this.state.audioMimeType || 'audio/webm'
                        };
                        alert('Audio recording saved locally (upload requires internet connection)');
                    };
                    reader.readAsDataURL(audioBlob);
                    return;
                }

                try {
                    const timestamp = Date.now();
                    const fileExtension = this.state.audioMimeType ? this.state.audioMimeType.split('/')[1] : 'webm';
                    const fileName = `activities/audio/${timestamp}_recording.${fileExtension}`;
                    const storageRef = this.state.firebaseStorage.ref(fileName);
                    
                    const metadata = {
                        contentType: this.state.audioMimeType || 'audio/webm',
                        customMetadata: {
                            duration: this.state.recordingTime.toString(),
                            recordedAt: new Date().toISOString()
                        }
                    };
                    
                    console.log('Uploading audio to Firebase Storage...');
                    const snapshot = await storageRef.put(audioBlob, metadata);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    this.state.formData.audioRecording = {
                        url: downloadURL,
                        duration: this.state.recordingTime,
                        recordedAt: new Date().toISOString(),
                        mimeType: this.state.audioMimeType || 'audio/webm'
                    };

                    console.log('Audio recording saved successfully:', downloadURL);
                    alert('Audio recording saved successfully');
                } catch (error) {
                    console.error('Error saving audio:', error);
                    alert('Error saving audio recording: ' + error.message);
                }
            }

            // File Upload
            async handleFileUpload(event, customerId) {
                const file = event.target.files[0];
                if (!file || file.type !== 'application/pdf') {
                    alert('Please select a PDF file');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    alert('File size must be less than 10MB');
                    return;
                }
                
                this.state.uploadingFile = true;
                this.render();
                
                try {
                    if (this.state.firebaseStorage && this.state.isOnline) {
                        const timestamp = Date.now();
                        const fileName = `customers/${customerId || 'temp'}/${timestamp}_${file.name}`;
                        const storageRef = this.state.firebaseStorage.ref(fileName);
                        
                        const snapshot = await storageRef.put(file);
                        const downloadURL = await snapshot.ref.getDownloadURL();
                        
                        // Add file info to customer or form data
                        const target = customerId ? 
                            this.state.customers.find(c => c.id === customerId) : 
                            this.state.formData;
                            
                        if (!target.attachments) {
                            target.attachments = [];
                        }
                        
                        target.attachments.push({
                            id: timestamp.toString(),
                            name: file.name,
                            url: downloadURL,
                            uploadedAt: new Date().toISOString(),
                            size: file.size
                        });
                        
                        if (customerId) {
                            // Update existing customer
                            this.saveAllToLocalStorage();
                            
                            if (this.state.firebaseDb) {
                                await this.state.firebaseDb.ref(`customers/${customerId}`).set(
                                    this.state.customers.find(c => c.id === customerId)
                                );
                            }
                        }
                        
                        alert('File uploaded successfully');
                        this.render();
                    } else {
                        alert('File upload requires online connection and Firebase configuration');
                    }
                } catch (error) {
                    console.error('Error uploading file:', error);
                    alert('Error uploading file. Please try again.');
                } finally {
                    this.state.uploadingFile = false;
                    this.render();
                }
            }

            async deleteAttachment(customerId, attachmentId) {
                if (!confirm('Are you sure you want to delete this attachment?')) return;
                
                const customer = customerId ? 
                    this.state.customers.find(c => c.id === customerId) : 
                    this.state.formData;
                    
                if (!customer || !customer.attachments) return;
                
                const attachment = customer.attachments.find(a => a.id === attachmentId);
                if (!attachment) return;
                
                try {
                    // Delete from Firebase Storage
                    if (this.state.firebaseStorage && this.state.isOnline && attachment.url) {
                        const storageRef = this.state.firebaseStorage.refFromURL(attachment.url);
                        await storageRef.delete();
                    }
                    
                    // Remove from customer data
                    customer.attachments = customer.attachments.filter(a => a.id !== attachmentId);
                    
                    if (customerId) {
                        // Update localStorage and Firebase
                        this.saveAllToLocalStorage();
                        
                        if (this.state.firebaseDb && this.state.isOnline) {
                            await this.state.firebaseDb.ref(`customers/${customerId}`).set(customer);
                        }
                    }
                    
                    this.render();
                } catch (error) {
                    console.error('Error deleting attachment:', error);
                    alert('Error deleting attachment');
                }
            }

            // CRUD Operations
            handleAddCustomer() {
                const newCustomer = {
                    id: Date.now().toString(),
                    ...this.state.formData,
                    industry: this.state.formData.industry === 'Other' 
                        ? (this.state.formData.customIndustry || 'Other') 
                        : this.state.formData.industry,
                    status: this.state.formData.status || 'prospect',
                    pipelineStage: this.state.formData.pipelineStage || 'lead',
                    primaryProducts: this.state.formData.primaryProducts || [],
                    preferredContact: this.state.formData.preferredContact || 'Any',
                    attachments: this.state.formData.attachments || [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                delete newCustomer.customIndustry;
                
                this.state.customers.push(newCustomer);
                this.saveAllToLocalStorage();
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`customers/${newCustomer.id}`).set(newCustomer);
                }
                
                this.closeModal();
            }

            handleUpdateCustomer() {
                const updatedData = {
                    ...this.state.formData,
                    industry: this.state.formData.industry === 'Other' 
                        ? (this.state.formData.customIndustry || 'Other') 
                        : this.state.formData.industry,
                    primaryProducts: this.state.formData.primaryProducts || [],
                    preferredContact: this.state.formData.preferredContact || 'Any',
                    attachments: this.state.formData.attachments || []
                };
                
                delete updatedData.customIndustry;
                
                const index = this.state.customers.findIndex(c => c.id === this.state.editingCustomer.id);
                if (index !== -1) {
                    this.state.customers[index] = {
                        ...this.state.editingCustomer,
                        ...updatedData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    this.saveAllToLocalStorage();
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`customers/${this.state.editingCustomer.id}`)
                            .set(this.state.customers[index]);
                    }
                }
                
                this.closeModal();
            }

            handleDeleteCustomer(customerId) {
                if (confirm('Delete this customer?')) {
                    this.state.customers = this.state.customers.filter(c => c.id !== customerId);
                    this.state.opportunities = this.state.opportunities.filter(o => o.customerId !== customerId);
                    this.state.activities = this.state.activities.filter(a => a.customerId !== customerId);
                    
                    this.saveAllToLocalStorage();
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`customers/${customerId}`).remove();
                    }
                    
                    this.render();
                }
            }

            handleAddOpportunity() {
                const newOpportunity = {
                    id: Date.now().toString(),
                    ...this.state.formData,
                    stage: 'new',
                    salesRep: 'Kaleb Smith',
                    createdAt: new Date().toISOString()
                };
                
                this.state.opportunities.push(newOpportunity);
                this.saveAllToLocalStorage();
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`opportunities/${newOpportunity.id}`).set(newOpportunity);
                }
                
                this.closeModal();
            }

            handleAddQuote() {
                const newQuote = {
                    id: Date.now().toString(),
                    quoteNumber: `Q-${new Date().getFullYear()}-${String(this.state.quotes.length + 1).padStart(3, '0')}`,
                    quoteName: this.state.formData.quoteName || 'New Quote',
                    ...this.state.formData,
                    status: 'draft',
                    createdAt: new Date().toISOString()
                };
                
                this.state.quotes.push(newQuote);
                this.saveAllToLocalStorage();
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`quotes/${newQuote.id}`).set(newQuote);
                }
                
                this.closeModal();
            }

            async handleAddActivity() {
                if (this.state.editingActivity) {
                    const index = this.state.activities.findIndex(a => a.id === this.state.editingActivity.id);
                    if (index !== -1) {
                        this.state.activities[index] = {
                            ...this.state.editingActivity,
                            ...this.state.formData,
                            updatedAt: new Date().toISOString()
                        };
                        
                        this.saveAllToLocalStorage();
                        
                        if (this.state.firebaseDb && this.state.isOnline) {
                            await this.state.firebaseDb.ref(`activities/${this.state.editingActivity.id}`)
                                .set(this.state.activities[index]);
                        }
                    }
                } else {
                    const newActivity = {
                        id: Date.now().toString(),
                        ...this.state.formData,
                        completed: false,
                        followUpCreated: false,
                        pipelineStage: this.state.formData.pipelineStage || 
                            this.state.customers.find(c => c.id === this.state.formData.customerId)?.pipelineStage || 'lead',
                        createdAt: new Date().toISOString()
                    };
                    
                    // Handle local audio data upload if online
                    if (newActivity.audioRecording && newActivity.audioRecording.localData && this.state.firebaseStorage && this.state.isOnline) {
                        try {
                            // Convert base64 back to blob and upload
                            const response = await fetch(newActivity.audioRecording.localData);
                            const blob = await response.blob();
                            
                            const timestamp = Date.now();
                            const fileExtension = newActivity.audioRecording.mimeType ? newActivity.audioRecording.mimeType.split('/')[1] : 'webm';
                            const fileName = `activities/audio/${timestamp}_recording.${fileExtension}`;
                            const storageRef = this.state.firebaseStorage.ref(fileName);
                            
                            const metadata = {
                                contentType: newActivity.audioRecording.mimeType || 'audio/webm'
                            };
                            
                            const snapshot = await storageRef.put(blob, metadata);
                            const downloadURL = await snapshot.ref.getDownloadURL();
                            
                            // Replace local data with URL
                            newActivity.audioRecording = {
                                url: downloadURL,
                                duration: newActivity.audioRecording.duration,
                                recordedAt: newActivity.audioRecording.recordedAt,
                                mimeType: newActivity.audioRecording.mimeType
                            };
                        } catch (error) {
                            console.error('Error uploading local audio:', error);
                        }
                    }
                    
                    this.state.activities.push(newActivity);
                    this.saveAllToLocalStorage();
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        await this.state.firebaseDb.ref(`activities/${newActivity.id}`).set(newActivity);
                    }

                    if (this.state.formData.addToCalendar && this.state.googleCalendarConnected) {
                        await this.addToGoogleCalendar(newActivity);
                    }
                }
                
                this.closeModal();
            }

            markActivityComplete(activityId) {
                const activity = this.state.activities.find(a => a.id === activityId);
                if (activity) {
                    activity.completed = true;
                    activity.completedDate = new Date().toISOString();
        
                    this.saveAllToLocalStorage();
        
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`activities/${activity.id}`).set(activity);
                }
        
                this.state.showFollowUp = activity;
                this.render();
    }
}

            createFollowUp(originalActivity, followUpData) {
                const newActivity = {
                    id: Date.now().toString(),
                    customerId: originalActivity.customerId,
                    type: followUpData.type,
                    subject: followUpData.subject,
                    date: followUpData.date,
                    time: followUpData.time,
                    notes: followUpData.notes,
                    completed: false,
                    followUpCreated: false,
                    pipelineStage: followUpData.pipelineStage,
                    createdAt: new Date().toISOString()
                };
                
                this.state.activities.push(newActivity);
                originalActivity.followUpCreated = true;
                
                this.saveAllToLocalStorage();
                
                if (this.state.firebaseDb && this.state.isOnline) {
                    this.state.firebaseDb.ref(`activities/${newActivity.id}`).set(newActivity);
                    this.state.firebaseDb.ref(`activities/${originalActivity.id}`).set(originalActivity);
                }
                
                this.state.showFollowUp = null;
                this.render();
            }

            viewActivity(activityId) {
                const activity = this.state.activities.find(a => a.id === activityId);
                if (activity) {
                    this.state.viewingActivity = activity;
                    this.state.showModal = 'view-activity';
                    this.render();
                }
            }

            editActivity(activityId) {
                const activity = this.state.activities.find(a => a.id === activityId);
                if (activity) {
                    this.state.editingActivity = activity;
                    this.state.formData = { ...activity };
                    this.state.showModal = 'activity';
                    this.render();
                }
            }

            deleteActivity(id) {
                if (confirm('Delete this activity?')) {
                    this.state.activities = this.state.activities.filter(a => a.id !== id);
                    this.saveAllToLocalStorage();
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`activities/${id}`).remove();
                    }
                    
                    this.render();
                }
            }

            // Modal handling
            openModal(type) {
                this.state.showModal = type;
                this.state.formData = {};
                this.state.editingCustomer = null;
                this.state.editingActivity = null;
                this.state.viewingActivity = null;
                this.render();
            }

            closeModal() {
                this.state.showModal = null;
                this.state.formData = {};
                this.state.editingCustomer = null;
                this.state.editingActivity = null;
                this.state.viewingActivity = null;
                this.render();
            }

            // View handling
            setView(view) {
                this.state.activeView = view;
                this.state.mobileMenuOpen = false;
                this.state.globalSearchResults = null;
                this.state.globalSearchTerm = '';
                this.closeModal();
                this.render();
            }

            toggleMobileMenu() {
                this.state.mobileMenuOpen = !this.state.mobileMenuOpen;
                this.render();
            }

            updateSearchTerm(value) {
                this.state.searchTerm = value;
                this.render();
            }

            updateIndustryFilter(value) {
                this.state.industryFilter = value;
                this.render();
            }

            updatePipelineFilter(value) {
                this.state.pipelineFilter = value;
                this.render();
            }

            updateStatusFilter(value) {
                this.state.statusFilter = value;
                this.render();
            }

            updateActivityFilter(value) {
                this.state.activityFilter = value;
                this.render();
            }

            updateFormField(field, value) {
                this.state.formData[field] = value;
                 // Don't render on every keystroke - let the form handle its own state
            }

            updateCharCount(field, value, maxLength) {
                const counter = document.getElementById(`${field}-counter`);
                if (counter) {
                    counter.textContent = `${value.length}/${maxLength}`;
                }
            }

            toggleProductSelection(product) {
                if (!this.state.formData.primaryProducts) {
                    this.state.formData.primaryProducts = [];
                }
                
                const index = this.state.formData.primaryProducts.indexOf(product);
                if (index > -1) {
                    this.state.formData.primaryProducts.splice(index, 1);
                } else {
                    this.state.formData.primaryProducts.push(product);
                }
                
                this.render();
            }

            editCustomer(customerId) {
                const customer = this.state.customers.find(c => c.id === customerId);
                if (customer) {
                    this.state.editingCustomer = customer;
                    const isCustomIndustry = customer.industry && !INDUSTRIES.includes(customer.industry);
                    this.state.formData = {
                        ...customer,
                        industry: isCustomIndustry ? 'Other' : customer.industry,
                        customIndustry: isCustomIndustry ? customer.industry : ''
                    };
                    this.state.showModal = 'customer';
                    this.render();
                }
            }

            viewCustomerDetails(customerId) {
                this.state.viewingCustomerId = customerId;
                this.state.customerDetailTab = 'opportunities';
                this.state.showModal = 'customer-details';
                this.render();
            }

            scheduleActivityForCustomer(customerId) {
                const customer = this.state.customers.find(c => c.id === customerId);
                if (customer) {
                    this.state.formData = {
                        customerId: customer.id,
                        type: 'call',
                        subject: `Follow up with ${customer.name}`,
                        date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: '10:00 AM',
                        notes: ''
                    };
                    this.state.showModal = 'activity';
                    this.render();
                }
            }

            createActivityForOpportunity(oppId) {
                const opp = this.state.opportunities.find(o => o.id === oppId);
                if (opp) {
                    this.state.formData = {
                        customerId: opp.customerId,
                        opportunityId: opp.id,
                        subject: `Follow up: ${opp.title}`,
                        type: 'call',
                        date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        time: '10:00 AM',
                        notes: ''
                    };
                    this.state.showModal = 'activity';
                    this.render();
                }
            }

            handleModalSubmit() {
                switch(this.state.showModal) {
                    case 'customer':
                        if (this.state.editingCustomer) {
                            this.handleUpdateCustomer();
                        } else {
                            this.handleAddCustomer();
                        }
                        break;
                    case 'opportunity':
                        this.handleAddOpportunity();
                        break;
                    case 'quote':
                        this.handleAddQuote();
                        break;
                    case 'activity':
                        this.handleAddActivity();
                        break;
                }
            }

            showOpportunityDetails(oppId) {
                this.state.selectedOpp = this.state.opportunities.find(o => o.id === oppId);
                this.render();
            }

            closeOpportunityDetails() {
                this.state.selectedOpp = null;
                this.render();
            }

            handleDragStart(event, oppId) {
                event.dataTransfer.setData('opportunityId', oppId);
                event.target.classList.add('dragging');
            }

            handleDrop(event, newStage) {
                event.preventDefault();
                const oppId = event.dataTransfer.getData('opportunityId');
                const opportunity = this.state.opportunities.find(o => o.id === oppId);
                
                if (opportunity) {
                    opportunity.stage = newStage;
                    opportunity.updatedAt = new Date().toISOString();
                    
                    this.saveAllToLocalStorage();
                    
                    if (this.state.firebaseDb && this.state.isOnline) {
                        this.state.firebaseDb.ref(`opportunities/${oppId}`).set(opportunity);
                    }
                    
                    this.render();
                }
                
                document.querySelectorAll('.dragging').forEach(el => {
                    el.classList.remove('dragging');
                });
            }

            closeFollowUp() {
                this.state.showFollowUp = null;
                this.render();
            }

            selectSuggestedAction(subject, stage) {
                document.getElementById('followup-subject').value = subject;
                document.getElementById('followup-stage').value = stage;
            }

            createFollowUpFromModal() {
                const followUpData = {
                    type: document.getElementById('followup-type').value,
                    subject: document.getElementById('followup-subject').value,
                    date: document.getElementById('followup-date').value,
                    time: document.getElementById('followup-time').value,
                    notes: document.getElementById('followup-notes').value,
                    pipelineStage: document.getElementById('followup-stage').value
                };
                
                if (!followUpData.subject) {
                    alert('Please enter a subject');
                    return;
                }
                
                this.createFollowUp(this.state.showFollowUp, followUpData);
            }

            toggleShowCompletedActivities() {
                this.state.showCompletedActivities = !this.state.showCompletedActivities;
                this.render();
            }

            toggleShowCompletedDashboard() {
                this.state.showCompletedActivities = !this.state.showCompletedActivities;
                this.render();
            }

            toggleShowCompletedPipeline() {
                this.state.showCompletedActivities = !this.state.showCompletedActivities;
                this.render();
            }

            toggleShowCompletedModal() {
                this.state.showCompletedActivities = !this.state.showCompletedActivities;
                this.render();
            }

            // Render methods
            render() {
                const app = document.getElementById('app');
                if (!app) return;
                
                app.innerHTML = `
                    <div class="flex min-h-screen bg-gray-100">
                        ${this.renderNavigation()}
                        
                        <div class="flex-1 overflow-y-auto lg:ml-64">
                            <div class="lg:hidden h-20"></div>
                            ${this.renderActiveView()}
                        </div>
                        
                        ${this.renderModals()}
                    </div>
                `;
            }

            renderActiveView() {
                switch(this.state.activeView) {
                    case 'dashboard':
                        return this.renderDashboard();
                    case 'customers':
                        return this.renderCustomers();
                    case 'pipeline':
                        return this.renderPipeline();
                    case 'quotes':
                        return this.renderQuotes();
                    case 'activities':
                        return this.renderActivities();
                    default:
                        return this.renderDashboard();
                }
            }

            renderNavigation() {
                return `
                    <!-- Mobile Header -->
                    <div class="lg:hidden bg-gray-900 text-white p-4 flex items-center justify-between fixed top-0 left-0 right-0 z-50 safe-top">
                        <div>
                            <h1 class="text-xl font-bold">Major Metals CRM</h1>
                            <p class="text-gray-400 text-xs">Steel Tubing Solutions</p>
                        </div>
                        <button onclick="app.toggleMobileMenu()" class="p-2 hover:bg-gray-800 rounded-lg">
                            ${this.icon('Menu', 24)}
                        </button>
                    </div>
                    
                    <!-- Mobile Menu Overlay -->
                    ${this.state.mobileMenuOpen ? `
                        <div class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-40" style="padding-top: 80px"
                             onclick="app.toggleMobileMenu()"></div>
                    ` : ''}
                    
                    <!-- Navigation Sidebar -->
                    <div class="bg-gray-900 text-white w-64 min-h-screen p-4 flex flex-col fixed lg:static lg:translate-x-0 transition-transform z-40 ${
                        this.state.mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'
                    }" style="padding-top: ${this.state.mobileMenuOpen ? '80px' : '16px'}">
                        <div class="mb-8 hidden lg:block">
                            <h1 class="text-2xl font-bold">Major Metals CRM</h1>
                            <p class="text-gray-400 text-sm">Steel Tubing Solutions</p>
                        </div>
                        
                        <!-- Global Search -->
                        <div class="mb-6">
                            <div class="relative">
                                <input type="text" 
                                       placeholder="Search everything..."
                                       value="${this.state.globalSearchTerm}"
                                       oninput="app.updateGlobalSearch(this.value)"
                                       class="w-full bg-gray-800 text-white px-4 py-2 pl-10 rounded-lg outline-none focus:bg-gray-700">
                                ${this.icon('Search', 20, 'absolute left-3 top-2.5 text-gray-400')}
                            </div>
                            ${this.state.globalSearchResults ? `
                                <div class="mt-2 bg-gray-800 rounded-lg p-2 max-h-64 overflow-y-auto">
                                    ${this.renderGlobalSearchResults()}
                                </div>
                            ` : ''}
                        </div>
                        
                        <nav class="space-y-2 flex-1">
                            ${[
                                { id: 'dashboard', icon: 'BarChart3', label: 'Dashboard' },
                                { id: 'customers', icon: 'Users', label: 'Customers' },
                                { id: 'pipeline', icon: 'TrendingUp', label: 'Sales Pipeline' },
                                { id: 'quotes', icon: 'FileText', label: 'Quotes' },
                                { id: 'activities', icon: 'Calendar', label: 'Activities' }
                            ].map(item => `
                                <button onclick="app.setView('${item.id}')" 
                                        class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg transition-colors ${
                                            this.state.activeView === item.id ? 'bg-blue-600' : 'hover:bg-gray-800'
                                        }">
                                    ${this.icon(item.icon, 20)}
                                    <span>${item.label}</span>
                                </button>
                            `).join('')}
                        </nav>
                        
                        <div class="mt-8 pt-8 border-t border-gray-800">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    ${this.state.isOnline ? 
                                        this.icon('Cloud', 16, 'text-green-500') : 
                                        this.icon('CloudOff', 16, 'text-red-500')
                                    }
                                    <span class="text-xs text-gray-400">
                                        ${this.state.isOnline ? 'Online' : 'Offline'}
                                    </span>
                                </div>
                                ${this.state.isSyncing ? 
                                    this.icon('RefreshCw', 16, 'text-blue-500 animate-spin') : ''
                                }
                            </div>
                            ${this.state.lastSync ? `
                                <p class="text-xs text-gray-500">
                                    Last sync: ${new Date(this.state.lastSync).toLocaleTimeString()}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            renderGlobalSearchResults() {
                const results = this.state.globalSearchResults;
                const hasResults = Object.values(results).some(arr => arr.length > 0);

                if (!hasResults) {
                    return '<p class="text-gray-400 text-sm p-2">No results found</p>';
                }

                return `
                    ${results.customers.length > 0 ? `
                        <div class="mb-3">
                            <p class="text-xs text-gray-400 mb-1">Customers</p>
                            ${results.customers.slice(0, 3).map(customer => `
                                <button onclick="app.viewCustomerDetails('${customer.id}')"
                                        class="w-full text-left p-2 hover:bg-gray-700 rounded text-sm">
                                    ${customer.name}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${results.activities.length > 0 ? `
                        <div class="mb-3">
                            <p class="text-xs text-gray-400 mb-1">Activities</p>
                            ${results.activities.slice(0, 3).map(activity => `
                                <button onclick="app.viewActivity('${activity.id}')"
                                        class="w-full text-left p-2 hover:bg-gray-700 rounded text-sm">
                                    ${activity.subject}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${results.opportunities.length > 0 ? `
                        <div>
                            <p class="text-xs text-gray-400 mb-1">Opportunities</p>
                            ${results.opportunities.slice(0, 3).map(opp => `
                                <div class="p-2 hover:bg-gray-700 rounded text-sm">
                                    ${opp.title}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
            }

            renderDashboard() {
                const metrics = this.getMetrics();
                
                return `
                    <div class="p-4 lg:p-8">
                        <h2 class="text-2xl lg:text-3xl font-bold mb-6 lg:mb-8">Sales Dashboard</h2>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-6 lg:mb-8">
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    ${this.icon('Package', 24, 'text-blue-500')}
                                    <span class="text-sm text-gray-500">Open Opportunities</span>
                                </div>
                                <p class="text-2xl font-bold">${metrics.openOpportunities}</p>
                                <p class="text-sm text-gray-600">$${(metrics.totalPipeline / 1000).toFixed(0)}K in pipeline</p>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    ${this.icon('DollarSign', 24, 'text-green-500')}
                                    <span class="text-sm text-gray-500">Won Deals</span>
                                </div>
                                <p class="text-2xl font-bold">$${(metrics.wonDeals / 1000).toFixed(0)}K</p>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    ${this.icon('TrendingUp', 24, 'text-purple-500')}
                                    <span class="text-sm text-gray-500">Win Rate</span>
                                </div>
                                <p class="text-2xl font-bold">${metrics.winRate}%</p>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    ${this.icon('Users', 24, 'text-orange-500')}
                                    <span class="text-sm text-gray-500">Active Customers</span>
                                </div>
                                <p class="text-2xl font-bold">${metrics.activeCustomers}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg lg:text-xl font-semibold">Recent Activities</h3>
                                    <button onclick="app.toggleShowCompletedDashboard()"
                                            class="text-sm text-blue-600 hover:text-blue-800">
                                        ${this.state.showCompletedActivities ? 'Hide' : 'Show'} Completed
                                    </button>
                                </div>
                                ${this.state.activities.length === 0 ? `
                                    <p class="text-gray-400">No activities yet</p>
                                ` : `
                                    <div class="space-y-3">
                                        ${this.state.activities
                                            .filter(a => this.state.showCompletedActivities || !a.completed)
                                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                                            .slice(0, 5)
                                            .map(activity => {
                                                const customer = this.state.customers.find(c => c.id === activity.customerId);
                                                return `
                                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded ${
                                                        activity.completed ? 'cursor-pointer hover:bg-gray-100' : ''
                                                    }" ${activity.completed ? `onclick="app.viewActivity('${activity.id}')"` : ''}>
                                                        <div class="flex items-center space-x-3">
                                                            ${activity.type === 'call' ? this.icon('Phone', 16) : 
                                                              activity.type === 'email' ? this.icon('Mail', 16) : 
                                                              this.icon('Calendar', 16)}
                                                            <div>
                                                                <p class="font-medium text-sm">${activity.subject}</p>
                                                                <p class="text-xs text-gray-600">
                                                                    ${customer?.name || 'Unknown'} • ${activity.date}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        ${activity.completed ? 
                                                            this.icon('Check', 16, 'text-green-500') : 
                                                            this.icon('Clock', 16, 'text-yellow-500')
                                                        }
                                                    </div>
                                                `;
                                            }).join('')}
                                    </div>
                                `}
                            </div>
                            
                            <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                                <h3 class="text-lg lg:text-xl font-semibold mb-4">Top Opportunities</h3>
                                ${this.state.opportunities.length === 0 ? `
                                    <p class="text-gray-400">No opportunities yet</p>
                                ` : `
                                    <div class="space-y-2">
                                        ${this.state.opportunities
                                            .filter(o => o.stage !== 'won' && o.stage !== 'lost')
                                            .sort((a, b) => (b.value || 0) - (a.value || 0))
                                            .slice(0, 5)
                                            .map(opp => {
                                                const customer = this.state.customers.find(c => c.id === opp.customerId);
                                                return `
                                                    <div class="p-3 bg-gray-50 rounded">
                                                        <div class="flex justify-between items-start">
                                                            <div>
                                                                <p class="font-medium">${opp.title}</p>
                                                                <p class="text-sm text-gray-600">${customer?.name || 'Unknown'}</p>
                                                            </div>
                                                            <p class="text-sm font-semibold">$${((opp.value || 0) / 1000).toFixed(0)}K</p>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderCustomers() {
                const filteredCustomers = this.state.customers.filter(c => {
                    const matchesSearch = c.name.toLowerCase().includes(this.state.searchTerm.toLowerCase());
                    const matchesIndustry = this.state.industryFilter === 'all' || c.industry === this.state.industryFilter;
                    const matchesPipeline = this.state.pipelineFilter === 'all' || c.pipelineStage === this.state.pipelineFilter;
                    const matchesStatus = this.state.statusFilter === 'all' || c.status === this.state.statusFilter;
                    return matchesSearch && matchesIndustry && matchesPipeline && matchesStatus;
                });

                return `
                    <div class="p-4 lg:p-8">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 lg:mb-8 space-y-4 sm:space-y-0">
                            <h2 class="text-2xl lg:text-3xl font-bold">Customers</h2>
                            <div class="flex space-x-2">
                                ${this.state.bulkMode ? `
                                    <button onclick="app.toggleBulkMode()"
                                            class="flex items-center space-x-2 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                        ${this.icon('X', 20)}
                                        <span>Cancel</span>
                                    </button>
                                    <button onclick="app.executeBulkAction()"
                                            class="flex items-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                        ${this.icon('Check', 20)}
                                        <span>Apply (${this.state.selectedItems.size})</span>
                                    </button>
                                ` : `
                                    <button onclick="app.toggleBulkMode()"
                                            class="flex items-center space-x-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                        ${this.icon('Copy', 20)}
                                        <span>Bulk</span>
                                    </button>
                                    <button onclick="app.openModal('customer')"
                                            class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                        ${this.icon('Plus', 20)}
                                        <span>Add</span>
                                    </button>
                                `}
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                                    <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 flex-1">
                                        <input type="text" placeholder="Search customers..."
                                               value="${this.state.searchTerm}"
                                               oninput="app.updateSearchTerm(this.value)"
                                               class="flex-1 outline-none px-4 py-2 border rounded-lg">
                                        <select onchange="app.updateIndustryFilter(this.value)"
                                                class="px-4 py-2 border rounded-lg w-full sm:w-auto">
                                            <option value="all">All Industries</option>
                                            ${INDUSTRIES.map(industry => `
                                                <option value="${industry}" ${this.state.industryFilter === industry ? 'selected' : ''}>
                                                    ${industry}
                                                </option>
                                            `).join('')}
                                        </select>
                                        <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 flex-1">
    <input type="text" placeholder="Search customers..."
           value="${this.state.searchTerm}"
           oninput="app.updateSearchTerm(this.value)"
           class="flex-1 outline-none px-4 py-2 border rounded-lg">
    <select onchange="app.updateIndustryFilter(this.value)"
            class="px-4 py-2 border rounded-lg w-full sm:w-auto">
        <option value="all">All Industries</option>
        ${INDUSTRIES.map(industry => `
            <option value="${industry}" ${this.state.industryFilter === industry ? 'selected' : ''}>
                ${industry}
            </option>
        `).join('')}
    </select>
    <select onchange="app.updatePipelineFilter(this.value)"
            class="px-4 py-2 border rounded-lg w-full sm:w-auto">
        <option value="all">All Stages</option>
        ${this.customerStages.map(stage => `
            <option value="${stage.id}" ${this.state.pipelineFilter === stage.id ? 'selected' : ''}>
                ${stage.name}
            </option>
        `).join('')}
    </select>
    <select onchange="app.updateStatusFilter(this.value)"
            class="px-4 py-2 border rounded-lg w-full sm:w-auto">
        <option value="all">All Status</option>
        <option value="prospect" ${this.state.statusFilter === 'prospect' ? 'selected' : ''}>Prospect</option>
        <option value="active" ${this.state.statusFilter === 'active' ? 'selected' : ''}>Active</option>
        <option value="inactive" ${this.state.statusFilter === 'inactive' ? 'selected' : ''}>Inactive</option>
    </select>
    ${this.state.bulkMode ? `
        <select id="bulk-action-select" class="px-4 py-2 border rounded-lg">
            <option value="">Select Action</option>
            <option value="update-stage">Update Stage</option>
            <option value="update-status">Update Status</option>
            <option value="delete">Delete</option>
            <option value="export">Export</option>
        </select>
    ` : ''}
</div>
                                        ${this.state.bulkMode ? `
                                            <select id="bulk-action-select" class="px-4 py-2 border rounded-lg">
                                                <option value="">Select Action</option>
                                                <option value="update-stage">Update Stage</option>
                                                <option value="update-status">Update Status</option>
                                                <option value="delete">Delete</option>
                                                <option value="export">Export</option>
                                            </select>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="divide-y">
                                ${filteredCustomers.map(customer => {
                                    const stage = this.customerStages.find(s => s.id === customer.pipelineStage);
                                    return `
                                        <div class="p-4 hover:bg-gray-50">
                                            <div class="flex items-start justify-between">
                                                <div class="flex items-start space-x-4">
                                                    ${this.state.bulkMode ? `
                                                        <input type="checkbox" 
                                                               class="bulk-checkbox mt-1"
                                                               ${this.state.selectedItems.has(customer.id) ? 'checked' : ''}
                                                               onchange="app.toggleSelectItem('${customer.id}')">
                                                    ` : ''}
                                                    <div>
                                                        <h3 class="font-semibold text-lg">${customer.name}</h3>
                                                        <p class="text-sm text-gray-600">${customer.industry || '-'}</p>
                                                        <div class="mt-2 space-y-1 text-sm">
                                                            <p>${this.icon('Users', 16, 'inline text-gray-400')} ${customer.contact}</p>
                                                            <p>${this.icon('Mail', 16, 'inline text-gray-400')} ${customer.email}</p>
                                                            <p>${this.icon('Phone', 16, 'inline text-gray-400')} ${customer.phone}</p>
                                                        </div>
                                                        ${customer.primaryProducts && customer.primaryProducts.length > 0 ? `
                                                            <div class="mt-2">
                                                                ${customer.primaryProducts.slice(0, 3).map(product => `
                                                                    <span class="product-tag">${product}</span>
                                                                `).join('')}
                                                                ${customer.primaryProducts.length > 3 ? `
                                                                    <span class="product-tag">+${customer.primaryProducts.length - 3} more</span>
                                                                ` : ''}
                                                            </div>
                                                        ` : ''}
                                                        <div class="mt-2 flex items-center space-x-2">
                                                            <span class="px-2 py-1 text-xs rounded-full ${
                                                                customer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                                            }">
                                                                ${customer.status}
                                                            </span>
                                                            ${stage ? `
                                                                <span class="px-2 py-1 text-xs rounded-full text-white ${stage.color}">
                                                                    ${stage.name}
                                                                </span>
                                                            ` : ''}
                                                            ${customer.preferredContact ? `
                                                                <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                                                    ${customer.preferredContact}
                                                                </span>
                                                            ` : ''}
                                                            ${customer.attachments && customer.attachments.length > 0 ? `
                                                                <span class="ml-2 text-gray-500" title="${customer.attachments.length} attachment(s)">
                                                                    ${this.icon('Paperclip', 14)}
                                                                </span>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                                ${!this.state.bulkMode ? `
                                                    <div class="flex items-center space-x-2">
                                                        <button onclick="app.viewCustomerDetails('${customer.id}')"
                                                                class="text-blue-600 hover:text-blue-800 p-2">
                                                            ${this.icon('Eye', 18)}
                                                        </button>
                                                        <button onclick="app.scheduleActivityForCustomer('${customer.id}')"
                                                                class="text-purple-600 hover:text-purple-800 p-2">
                                                            ${this.icon('Calendar', 18)}
                                                        </button>
                                                        <button onclick="app.editCustomer('${customer.id}')"
                                                                class="text-blue-600 hover:text-blue-800 p-2">
                                                            ${this.icon('Edit2', 18)}
                                                        </button>
                                                        <button onclick="app.handleDeleteCustomer('${customer.id}')"
                                                                class="text-red-600 hover:text-red-800 p-2">
                                                            ${this.icon('Trash2', 18)}
                                                        </button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    ${this.renderBulkUpdateModals()}
                `;
            }

            renderBulkUpdateModals() {
                if (!this.state.showModal?.startsWith('bulk-')) return '';

                if (this.state.showModal === 'bulk-stage') {
                    return `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                             onclick="app.closeModal()">
                            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"
                                 onclick="event.stopPropagation()">
                                <h3 class="text-lg font-semibold mb-4">Update Pipeline Stage</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    Update ${this.state.selectedItems.size} selected customers
                                </p>
                                <select id="bulk-stage-select" class="w-full p-2 border rounded-lg mb-4">
                                    ${this.customerStages.map(stage => `
                                        <option value="${stage.id}">${stage.name}</option>
                                    `).join('')}
                                </select>
                                <div class="flex justify-end space-x-3">
                                    <button onclick="app.closeModal()"
                                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                        Cancel
                                    </button>
                                    <button onclick="app.bulkUpdateStage(document.getElementById('bulk-stage-select').value)"
                                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        Update
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                return '';
            }

            renderPipeline() {
                return `
                    <div class="p-4 lg:p-8">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 lg:mb-8 space-y-4 sm:space-y-0">
                            <h2 class="text-2xl lg:text-3xl font-bold">Sales Pipeline</h2>
                            <div class="flex items-center space-x-4">
                                <button onclick="app.toggleShowCompletedPipeline()"
                                        class="text-sm text-blue-600 hover:text-blue-800">
                                    ${this.state.showCompletedActivities ? 'Hide' : 'Show'} Completed
                                </button>
                                <button onclick="app.openModal('opportunity')"
                                        class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    ${this.icon('Plus', 20)}
                                    <span>Add Opportunity</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 overflow-x-auto pb-4">
                            ${this.pipelineStages.map(stage => {
                                const stageOpps = this.state.opportunities.filter(o => o.stage === stage.id);
                                const stageValue = stageOpps.reduce((sum, o) => sum + (o.value || 0), 0);
                                
                                return `
                                    <div class="flex-shrink-0 w-72 lg:w-80"
                                         ondragover="event.preventDefault()"
                                         ondrop="app.handleDrop(event, '${stage.id}')">
                                        <div class="${stage.color} text-white p-3 rounded-t-lg">
                                            <h3 class="font-semibold">${stage.name}</h3>
                                            <p class="text-sm opacity-90">
                                                ${stageOpps.length} deals • ${(stageValue / 1000).toFixed(0)}K
                                            </p>
                                        </div>
                                        
                                        <div class="bg-gray-100 min-h-[400px] p-2">
                                            ${stageOpps.map(opp => {
                                                const customer = this.state.customers.find(c => c.id === opp.customerId);
                                                const activities = this.state.activities.filter(a => a.opportunityId === opp.id);
                                                
                                                return `
                                                    <div draggable="true"
                                                         ondragstart="app.handleDragStart(event, '${opp.id}')"
                                                         class="bg-white p-3 rounded-lg shadow mb-2 cursor-move hover:shadow-md transition-shadow"
                                                         onclick="app.showOpportunityDetails('${opp.id}')">
                                                        <h4 class="font-medium">${opp.title}</h4>
                                                        <p class="text-sm text-gray-600 mt-1">${customer?.name || 'Unknown'}</p>
                                                        <div class="flex justify-between items-center mt-3">
                                                            <span class="text-lg font-semibold">$${((opp.value || 0) / 1000).toFixed(0)}K</span>
                                                            <span class="text-sm text-gray-500">${opp.salesRep}</span>
                                                        </div>
                                                        <div class="mt-2 text-xs text-gray-500">
                                                            <p>Close: ${opp.expectedClose || 'Not set'}</p>
                                                            <p class="mt-1">Activities: ${activities.filter(a => a.completed).length}/${activities.length}</p>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${this.renderOpportunityDetailsModal()}
                    </div>
                `;
            }

            renderOpportunityDetailsModal() {
                if (!this.state.selectedOpp) return '';
                
                const opp = this.state.selectedOpp;
                const customer = this.state.customers.find(c => c.id === opp.customerId);
                const activities = this.state.activities.filter(a => a.opportunityId === opp.id);
                
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeOpportunityDetails()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-4 lg:p-6"
                             onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg lg:text-xl font-semibold">${opp.title}</h3>
                                <button onclick="app.closeOpportunityDetails()" class="text-gray-500 hover:text-gray-700 p-1">
                                    ${this.icon('X', 24)}
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Customer</p>
                                        <p class="font-medium">${customer?.name || 'Unknown'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Value</p>
                                        <p class="font-medium">$${(opp.value || 0).toLocaleString()}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="font-semibold">Activities</h4>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="app.toggleShowCompletedModal()"
                                                    class="text-sm text-blue-600 hover:text-blue-800">
                                                ${this.state.showCompletedActivities ? 'Hide' : 'Show'} Completed
                                            </button>
                                            <button onclick="app.createActivityForOpportunity('${opp.id}'); app.closeOpportunityDetails();"
                                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                                ${this.icon('Plus', 16, 'inline')} Add
                                            </button>
                                        </div>
                                    </div>
                                    <div class="space-y-2 max-h-64 overflow-y-auto">
                                        ${activities
                                            .filter(a => this.state.showCompletedActivities || !a.completed)
                                            .map(activity => `
                                                <div class="p-3 bg-gray-50 rounded ${
                                                    activity.completed ? 'cursor-pointer hover:bg-gray-100' : ''
                                                }" ${activity.completed ? `onclick="app.viewActivity('${activity.id}')"` : ''}>
                                                    <div class="flex items-center justify-between">
                                                        <div>
                                                            <p class="font-medium text-sm">${activity.subject}</p>
                                                            <p class="text-xs text-gray-600">${activity.date}</p>
                                                        </div>
                                                        ${activity.completed ? 
                                                            this.icon('Check', 16, 'text-green-500') : 
                                                            this.icon('Clock', 16, 'text-yellow-500')
                                                        }
                                                    </div>
                                                </div>
                                            `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderQuotes() {
                const quotes = this.state.quotes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                return `
                    <div class="p-4 lg:p-8 mt-16 lg:mt-0">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 lg:mb-8 space-y-4 sm:space-y-0">
                            <h2 class="text-2xl lg:text-3xl font-bold">Quotes</h2>
                            <button onclick="app.openModal('quote')"
                                    class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                ${this.icon('Plus', 20)}
                                <span>Create Quote</span>
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-4 lg:p-6">
                            ${quotes.length === 0 ? `
                                <p class="text-gray-400">No quotes yet</p>
                            ` : `
                                <div class="space-y-3">
                                    ${quotes.map(quote => {
                                        const customer = this.state.customers.find(c => c.id === quote.customerId);
                                        const relatedActivities = this.state.activities.filter(a => 
                                            a.customerId === quote.customerId && 
                                            a.notes?.includes(quote.quoteNumber)
                                        );
                                        
                                        return `
                                            <div class="p-4 border rounded-lg">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <h4 class="font-semibold">${quote.quoteName}</h4>
                                                        <p class="text-sm text-gray-500">${quote.quoteNumber}</p>
                                                        <p class="text-sm text-gray-600 mt-1">${customer?.name || 'Unknown'}</p>
                                                        ${this.state.showCompletedActivities && relatedActivities.length > 0 ? `
                                                            <p class="text-xs text-gray-500 mt-2">
                                                                ${relatedActivities.filter(a => a.completed).length}/${relatedActivities.length} activities completed
                                                            </p>
                                                        ` : ''}
                                                    </div>
                                                    <div class="text-right">
                                                        <span class="px-2 py-1 text-xs rounded-full ${
                                                            quote.status === 'sent' ? 'bg-blue-100 text-blue-800' :
                                                            quote.status === 'accepted' ? 'bg-green-100 text-green-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }">
                                                            ${quote.status}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }
            renderActivityCard(activity, isOverdue = false, isCompleted = false) {
                const customer = this.state.customers.find(c => c.id === activity.customerId);
                const pipelineStage = this.customerStages.find(s => s.id === activity.pipelineStage);
                const customerStatus = customer?.status || 'unknown';

                return `
                    <div class="border rounded-lg p-4 ${isOverdue ? 'bg-white border-red-200' : isCompleted ? 'bg-gray-50' : 'bg-white hover:shadow-sm transition-shadow'}">
                        <div class="flex items-start justify-between">
                            <div class="${isCompleted ? 'cursor-pointer' : ''}" 
                                 ${isCompleted ? `onclick="app.viewActivity('${activity.id}')"` : ''}>
                                <h4 class="font-medium ${isCompleted ? 'line-through text-gray-500' : ''}">${activity.subject}</h4>
                                <p class="text-sm text-gray-600">${customer?.name || 'Unknown'}</p>
                                <p class="text-sm ${isOverdue ? 'text-red-600' : 'text-gray-500'}">${activity.date} at ${activity.time}</p>
                                <div class="flex items-center gap-2 mt-2">
                                    ${pipelineStage ? `
                                        <span class="inline-flex items-center px-2 py-1 text-xs rounded-full text-white ${pipelineStage.color}">
                                            ${pipelineStage.name}
                                        </span>
                                    ` : ''}
                                    <span class="inline-flex items-center px-2 py-1 text-xs rounded-full ${
                                        customerStatus === 'active' ? 'bg-green-100 text-green-800' : 
                                        customerStatus === 'prospect' ? 'bg-blue-100 text-blue-800' : 
                                        customerStatus === 'inactive' ? 'bg-gray-100 text-gray-800' : 
                                        'bg-gray-100 text-gray-600'
                                    }">
                                        ${customerStatus}
                                    </span>
                                    ${activity.googleCalendarId ? `
                                        <span class="inline-flex items-center text-xs text-green-600">
                                            ${this.icon('Calendar', 12, 'inline')} Synced
                                        </span>
                                    ` : ''}
                                </div>
                                ${activity.notes ? `
                                    <p class="text-xs text-gray-500 mt-2 line-clamp-2">${activity.notes}</p>
                                ` : ''}
                                ${activity.audioRecording ? `
                                    <div class="mt-2">
                                        <audio controls class="w-full h-8" onclick="event.stopPropagation()">
                                            <source src="${activity.audioRecording.url || activity.audioRecording.localData}" 
                                                    type="${activity.audioRecording.mimeType || 'audio/webm'}">
                                        </audio>
                                        <p class="text-xs text-gray-400">
                                            Audio (${Math.floor(activity.audioRecording.duration / 60)}:${(activity.audioRecording.duration % 60).toString().padStart(2, '0')})
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                            ${!isCompleted ? `
                                <div class="flex items-center space-x-2">
                                    <button onclick="app.markActivityComplete('${activity.id}')"
                                            class="text-green-600 hover:text-green-800" title="Mark Complete">
                                        ${this.icon('Check', 20)}
                                    </button>
                                    <button onclick="app.editActivity('${activity.id}')"
                                            class="text-blue-600 hover:text-blue-800" title="Edit">
                                        ${this.icon('Edit2', 16)}
                                    </button>
                                    <button onclick="app.deleteActivity('${activity.id}')"
                                            class="text-red-600 hover:text-red-800" title="Delete">
                                        ${this.icon('Trash2', 16)}
                                    </button>
                                </div>
                            ` : `
                                <button onclick="app.viewActivity('${activity.id}')"
                                        class="text-blue-600 hover:text-blue-800 p-2" title="View Details">
                                    ${this.icon('Eye', 16)}
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }
            renderActivities() {
                const today = new Date().toISOString().split('T')[0];
                const thisWeekEnd = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const nextWeekStart = new Date(Date.now() + 8 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const nextWeekEnd = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                // Apply filters
                const filteredActivities = this.state.activities.filter(activity => {
                if (this.state.activityFilter === 'all') return true;
                if (this.state.activityFilter === 'overdue') return !activity.completed && activity.date < today;
                if (this.state.activityFilter === 'today') return activity.date === today;
                if (this.state.activityFilter === 'upcoming') return !activity.completed && activity.date >= today;
                if (this.customerStages.find(s => s.id === this.state.activityFilter)) {
                    return activity.pipelineStage === this.state.activityFilter;
                }

                // Status filter
                const customer = this.state.customers.find(c => c.id === activity.customerId);
                if (this.state.activityFilter === 'status-active') return customer?.status === 'active';
                if (this.state.activityFilter === 'status-prospect') return customer?.status === 'prospect';
                if (this.state.activityFilter === 'status-inactive') return customer?.status === 'inactive';

                return true;
                });

                // Group activities by time period
                const todayActivities = filteredActivities.filter(a => !a.completed && a.date === today);
                const thisWeekActivities = filteredActivities.filter(a => !a.completed && a.date > today && a.date <= thisWeekEnd);
                const nextWeekActivities = filteredActivities.filter(a => !a.completed && a.date >= nextWeekStart && a.date <= nextWeekEnd);
                const overdueActivities = filteredActivities.filter(a => !a.completed && a.date < today);
                const completedActivities = filteredActivities.filter(a => a.completed);

                return `
                <div class="p-4 lg:p-8 mt-16 lg:mt-0">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 lg:mb-8 space-y-4 sm:space-y-0">
                    <h2 class="text-2xl lg:text-3xl font-bold">Activities & Follow-ups</h2>
                    <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <select onchange="app.updateActivityFilter(this.value)"
                            class="px-4 py-2 border rounded-lg">
                        <option value="all">All Activities</option>
                        <optgroup label="Time">
                            <option value="today">Today</option>
                            <option value="upcoming">Upcoming</option>
                            <option value="overdue">Overdue</option>
                        </optgroup>
                        <optgroup label="Pipeline Stage">
                            ${this.customerStages.map(stage => `
                            <option value="${stage.id}">${stage.name}</option>
                            `).join('')}
                        </optgroup>
                        <optgroup label="Customer Status">
                            <option value="status-active">Active Customers</option>
                            <option value="status-prospect">Prospects</option>
                            <option value="status-inactive">Inactive</option>
                        </optgroup>
                        </select>
                        <button onclick="app.openModal('activity')"
                            class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        ${this.icon('Plus', 20)}
                        <span>Schedule Activity</span>
                        </button>
                    </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
                    <div class="lg:col-span-2 space-y-4">
                        ${overdueActivities.length > 0 ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-red-800 mb-3">
                            ${this.icon('AlertCircle', 20, 'inline mr-2')}
                            Overdue (${overdueActivities.length})
                            </h3>
                            <div class="space-y-2">
                            ${overdueActivities.map(activity => this.renderActivityCard(activity, true)).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${todayActivities.length > 0 ? `
                        <div class="bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold flex items-center">
                                ${this.icon('Calendar', 20, 'inline mr-2 text-blue-600')}
                                Today (${todayActivities.length})
                            </h3>
                            </div>
                            <div class="p-4 space-y-3">
                            ${todayActivities.map(activity => this.renderActivityCard(activity)).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${thisWeekActivities.length > 0 ? `
                        <div class="bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold flex items-center">
                                ${this.icon('Clock', 20, 'inline mr-2 text-purple-600')}
                                This Week (${thisWeekActivities.length})
                            </h3>
                            </div>
                            <div class="p-4 space-y-3">
                            ${thisWeekActivities.map(activity => this.renderActivityCard(activity)).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${nextWeekActivities.length > 0 ? `
                        <div class="bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold flex items-center">
                                ${this.icon('TrendingUp', 20, 'inline mr-2 text-green-600')}
                                Next Week (${nextWeekActivities.length})
                            </h3>
                            </div>
                            <div class="p-4 space-y-3">
                            ${nextWeekActivities.map(activity => this.renderActivityCard(activity)).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${this.state.showCompletedActivities && completedActivities.length > 0 ? `
                        <div class="bg-gray-50 rounded-lg shadow">
                            <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-lg font-semibold flex items-center text-gray-600">
                                ${this.icon('Check', 20, 'inline mr-2 text-green-600')}
                                Completed (${completedActivities.length})
                            </h3>
                            </div>
                            <div class="p-4 space-y-3">
                            ${completedActivities.slice(0, 10).map(activity => this.renderActivityCard(activity, false, true)).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${todayActivities.length === 0 && thisWeekActivities.length === 0 && nextWeekActivities.length === 0 && overdueActivities.length === 0 ? `
                        <div class="bg-white rounded-lg shadow p-8 text-center">
                            <p class="text-gray-500">No activities scheduled</p>
                        </div>
                        ` : ''}
                    </div>

                    <div class="space-y-4">
                        <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-semibold mb-4">Google Calendar</h3>
                        ${this.state.googleCalendarConnected ? `
                            <p class="text-sm text-green-600 mb-4">
                            ${this.icon('Check', 16, 'inline')} Connected
                            </p>
                            <p class="text-xs text-gray-500 mb-4">Activities will sync automatically</p>
                            <button onclick="app.disconnectGoogleCalendar()"
                                class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            Disconnect
                            </button>
                        ` : `
                            <p class="text-sm text-gray-600 mb-4">Connect to sync activities</p>
                            <button onclick="app.connectGoogleCalendar()"
                                class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Connect Google Calendar
                            </button>
                        `}
                        </div>

                        <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-semibold mb-4">Activity Summary</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                            <span class="text-gray-600">Today</span>
                            <span class="font-semibold">
                                ${todayActivities.length}
                            </span>
                            </div>
                            <div class="flex justify-between">
                            <span class="text-gray-600">This Week</span>
                            <span class="font-semibold">
                                ${thisWeekActivities.length}
                            </span>
                            </div>
                            <div class="flex justify-between">
                            <span class="text-gray-600">Overdue</span>
                            <span class="font-semibold text-red-600">${overdueActivities.length}</span>
                            </div>
                            <div class="flex justify-between">
                            <span class="text-gray-600">Completed</span>
                            <span class="font-semibold text-green-600">${completedActivities.length}</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <button onclick="app.toggleShowCompletedActivities()"
                                class="w-full text-sm text-blue-600 hover:text-blue-800">
                            ${this.state.showCompletedActivities ? 'Hide' : 'Show'} Completed Activities
                            </button>
                        </div>
                        </div>
                    </div>
                    </div>

                    ${this.renderFollowUpModal()}
                </div>
                `;
            }
            renderFollowUpModal() {
                if (!this.state.showFollowUp) return '';
    
                const activity = this.state.showFollowUp;
                const customer = this.state.customers.find(c => c.id === activity.customerId);
    
                const suggestedActions = [
                    { subject: `Follow up on ${activity.subject}`, stage: activity.pipelineStage },
                    { subject: `Check in with ${customer?.name || 'customer'}`, stage: 'qualified' },
                    { subject: 'Send updated quote', stage: 'quote_out' },
                    { subject: 'Schedule product demo', stage: 'negotiating' }
                ];
    
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                        onclick="app.closeFollowUp()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto p-6"
                            onclick="event.stopPropagation()">
                            <h3 class="text-lg font-semibold mb-4">Create Follow-up Activity</h3>
                
                            <div class="mb-4">
                                 <p class="text-sm text-gray-600">Completed: ${activity.subject}</p>
                                 <p class="text-xs text-gray-500">${customer?.name || 'Unknown'}</p>
                            </div>
                
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                <select id="followup-type" class="w-full p-2 border rounded-lg">
                                    <option value="call">Call</option>
                                    <option value="email">Email</option>
                                    <option value="meeting">Meeting</option>
                                </select>
                            </div>
                    
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                <input type="text" id="followup-subject" 
                                    class="w-full p-2 border rounded-lg"
                                    placeholder="Follow-up subject">
                            </div>
                    
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                    <input type="date" id="followup-date"
                                            value="${new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0]}"
                                            class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                                    <input type="text" id="followup-time"
                                        value="10:00 AM"
                                        class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pipeline Stage</label>
                                <select id="followup-stage" class="w-full p-2 border rounded-lg">
                                        ${this.customerStages.map(stage => `
                                            <option value="${stage.id}" ${stage.id === activity.pipelineStage ? 'selected' : ''}>
                                                ${stage.name}
                                            </option>
                                        `).join('')}
                                </select>
                            </div>
                    
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                <textarea id="followup-notes" rows="3"
                                        class="w-full p-2 border rounded-lg"
                                        placeholder="Additional notes..."></textarea>
                            </div>
                    
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-2">Suggested Actions:</p>
                                <div class="space-y-2">
                                    ${suggestedActions.map(action => `
                                        <button onclick="app.selectSuggestedAction('${action.subject}', '${action.stage}')"
                                                class="w-full text-left p-2 text-sm bg-gray-50 hover:bg-gray-100 rounded">
                                            ${action.subject}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                
                        <div class="flex justify-end space-x-3 mt-6">
                            <button onclick="app.closeFollowUp()"
                                    class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Skip Follow-up
                            </button>
                            <button onclick="app.createFollowUpFromModal()"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Create Follow-up
                            </button>
                        </div>
                </div>
        </div>
    `;
            }

            renderModals() {
                switch(this.state.showModal) {
                    case 'customer':
                        return this.renderCustomerModal();
                    case 'customer-details':
                        return this.renderCustomerDetailsModal();
                    case 'opportunity':
                        return this.renderOpportunityModal();
                    case 'quote':
                        return this.renderQuoteModal();
                    case 'activity':
                        return this.renderActivityModal();
                    case 'view-activity':
                        return this.renderViewActivityModal();
                    default:
                        return '';
                }
            }

            renderCustomerModal() {
                const isEditing = !!this.state.editingCustomer;
                const title = isEditing ? 'Edit Customer' : 'Add New Customer';
                
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeModal()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6"
                             onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-semibold">${title}</h3>
                                <button onclick="app.closeModal()" class="text-gray-500 hover:text-gray-700">
                                    ${this.icon('X', 24)}
                                </button>
                            </div>
                            
                            <form onsubmit="event.preventDefault(); app.handleModalSubmit()">
                                <div class="form-section">
                                    <h4 class="form-section-title">Basic Information</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                                            <input type="text"
                                                   value="${this.state.formData.name || ''}"
                                                   oninput="app.updateFormField('name', this.value)"
                                                   class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Industry</label>
                                            <select
                                                    value="${this.state.formData.industry || ''}"
                                                    onchange="app.updateFormField('industry', this.value)"
                                                    class="w-full p-2 border rounded-lg">
                                                <option value="">Select Industry</option>
                                                ${INDUSTRIES.map(industry => `
                                                    <option value="${industry}" ${this.state.formData.industry === industry ? 'selected' : ''}>
                                                        ${industry}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        ${this.state.formData.industry === 'Other' ? `
                                            <div class="md:col-span-2">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Specify Industry</label>
                                                <input type="text"
                                                       value="${this.state.formData.customIndustry || ''}"
                                                       oninput="app.updateFormField('customIndustry', this.value)"
                                                       class="w-full p-2 border rounded-lg">
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">Contact Information</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Primary Contact</label>
                                            <input type="text"
                                                   value="${this.state.formData.contact || ''}"
                                                   oninput="app.updateFormField('contact', this.value)"
                                                   class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                            <input type="email"
                                                   value="${this.state.formData.email || ''}"
                                                   oninput="app.updateFormField('email', this.value)"
                                                   class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                            <input type="tel"
                                                   value="${this.state.formData.phone || ''}"
                                                   oninput="app.updateFormField('phone', this.value)"
                                                   class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Preferred Contact Method</label>
                                            <select value="${this.state.formData.preferredContact || 'Any'}"
                                                    onchange="app.updateFormField('preferredContact', this.value)"
                                                    class="w-full p-2 border rounded-lg">
                                                ${CONTACT_METHODS.map(method => `
                                                    <option value="${method}" ${this.state.formData.preferredContact === method ? 'selected' : ''}>
                                                        ${method}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">Products of Interest</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        ${PRODUCTS.map(product => `
                                            <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded">
                                                <input type="checkbox" 
                                                       ${(this.state.formData.primaryProducts || []).includes(product) ? 'checked' : ''}
                                                       onchange="app.toggleProductSelection('${product}')"
                                                       class="rounded">
                                                <span class="text-sm">${product}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">Business Details</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Company Background</label>
                                            <textarea rows="3"
                                                      value="${this.state.formData.companyBackground || ''}"
                                                      oninput="app.updateFormField('companyBackground', this.value); app.updateCharCount('companyBackground', this.value, 500)"
                                                      maxlength="500"
                                                      class="w-full p-2 border rounded-lg"></textarea>
                                            <div id="companyBackground-counter" class="char-counter">0/500</div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Pipeline Stage</label>
                                                <select value="${this.state.formData.pipelineStage || 'lead'}"
                                                        onchange="app.updateFormField('pipelineStage', this.value)"
                                                        class="w-full p-2 border rounded-lg">
                                                    ${this.customerStages.map(stage => `
                                                        <option value="${stage.id}" ${this.state.formData.pipelineStage === stage.id ? 'selected' : ''}>
                                                            ${stage.name}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                                <select value="${this.state.formData.status || 'prospect'}"
                                                        onchange="app.updateFormField('status', this.value)"
                                                        class="w-full p-2 border rounded-lg">
                                                    <option value="prospect">Prospect</option>
                                                    <option value="active">Active</option>
                                                    <option value="inactive">Inactive</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">Online Presence</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                                            <input type="url"
                                                   value="${this.state.formData.website || ''}"
                                                   oninput="app.updateFormField('website', this.value)"
                                                   placeholder="https://example.com"
                                                   class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn</label>
                                            <input type="url"
                                                   value="${this.state.formData.linkedIn || ''}"
                                                   oninput="app.updateFormField('linkedIn', this.value)"
                                                   placeholder="https://linkedin.com/company/..."
                                                   class="w-full p-2 border rounded-lg">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">Attachments</h4>
                                    <div>
                                        <input type="file" id="file-upload" accept=".pdf"
                                               onchange="app.handleFileUpload(event)"
                                               class="hidden">
                                        <button type="button"
                                                onclick="document.getElementById('file-upload').click()"
                                                class="flex items-center space-x-2 px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400 ${this.state.uploadingFile ? 'opacity-50 cursor-not-allowed' : ''}"
                                                ${this.state.uploadingFile ? 'disabled' : ''}>
                                            ${this.icon('Upload', 20)}
                                            <span>${this.state.uploadingFile ? 'Uploading...' : 'Upload PDF'}</span>
                                        </button>
                                        
                                        ${(this.state.formData.attachments || []).length > 0 ? `
                                            <div class="mt-3 space-y-2">
                                                ${this.state.formData.attachments.map(attachment => `
                                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                        <div class="flex items-center space-x-2">
                                                            ${this.icon('Paperclip', 16, 'text-gray-500')}
                                                            <a href="${attachment.url}" target="_blank" 
                                                               class="text-sm text-blue-600 hover:underline">
                                                                ${attachment.name}
                                                            </a>
                                                        </div>
                                                        <button type="button"
                                                                onclick="app.deleteAttachment(null, '${attachment.id}')"
                                                                class="text-red-600 hover:text-red-800 p-1">
                                                            ${this.icon('X', 16)}
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="app.closeModal()"
                                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                        Cancel
                                    </button>
                                    <button type="submit"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        ${isEditing ? 'Update' : 'Add'} Customer
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }

            renderCustomerDetailsModal() {
                const customer = this.state.customers.find(c => c.id === this.state.viewingCustomerId);
                if (!customer) return '';

                const opportunities = this.state.opportunities.filter(o => o.customerId === customer.id);
                const activities = this.state.activities.filter(a => a.customerId === customer.id);
                const quotes = this.state.quotes.filter(q => q.customerId === customer.id);

                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeModal()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto"
                             onclick="event.stopPropagation()">
                            <div class="sticky top-0 bg-white border-b p-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-xl font-semibold">${customer.name}</h3>
                                        <p class="text-sm text-gray-600">${customer.industry}</p>
                                    </div>
                                    <button onclick="app.closeModal()" class="text-gray-500 hover:text-gray-700">
                                        ${this.icon('X', 24)}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                    <div>
                                        <p class="text-sm text-gray-500">Contact</p>
                                        <p class="font-medium">${customer.contact}</p>
                                        <p class="text-sm text-gray-600">${customer.email}</p>
                                        <p class="text-sm text-gray-600">${customer.phone}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Status</p>
                                        <div class="mt-1 space-y-1">
                                            <span class="inline-block px-2 py-1 text-xs rounded-full ${
                                                customer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                            }">
                                                ${customer.status}
                                            </span>
                                            ${this.customerStages.find(s => s.id === customer.pipelineStage) ? `
                                                <span class="inline-block px-2 py-1 text-xs rounded-full text-white ${
                                                    this.customerStages.find(s => s.id === customer.pipelineStage).color
                                                }">
                                                    ${this.customerStages.find(s => s.id === customer.pipelineStage).name}
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Preferred Contact</p>
                                        <span class="inline-block px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                            ${customer.preferredContact || 'Any'}
                                        </span>
                                    </div>
                                </div>

                                ${customer.primaryProducts && customer.primaryProducts.length > 0 ? `
                                    <div class="mb-6">
                                        <p class="text-sm text-gray-500 mb-2">Products of Interest</p>
                                        <div>
                                            ${customer.primaryProducts.map(product => `
                                                <span class="product-tag">${product}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="border-b mb-4">
                                    <nav class="flex space-x-8">
                                        ${[
                                            { id: 'opportunities', label: 'Opportunities', count: opportunities.length },
                                            { id: 'activities', label: 'Activities', count: activities.length },
                                            { id: 'quotes', label: 'Quotes', count: quotes.length },
                                            { id: 'details', label: 'Details', count: null }
                                        ].map(tab => `
                                            <button onclick="app.state.customerDetailTab = '${tab.id}'; app.render()"
                                                    class="pb-2 border-b-2 ${
                                                        this.state.customerDetailTab === tab.id 
                                                            ? 'border-blue-600 text-blue-600' 
                                                            : 'border-transparent text-gray-500 hover:text-gray-700'
                                                    }">
                                                ${tab.label}
                                                ${tab.count !== null ? `<span class="ml-2 text-sm">(${tab.count})</span>` : ''}
                                            </button>
                                        `).join('')}
                                    </nav>
                                </div>

                                ${this.renderCustomerDetailTab(customer, opportunities, activities, quotes)}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderCustomerDetailTab(customer, opportunities, activities, quotes) {
                switch(this.state.customerDetailTab) {
                    case 'opportunities':
                        return `
                            <div class="space-y-3">
                                ${opportunities.length === 0 ? `
                                    <p class="text-gray-400">No opportunities yet</p>
                                ` : opportunities.map(opp => {
                                    const stage = this.pipelineStages.find(s => s.id === opp.stage);
                                    return `
                                        <div class="border rounded-lg p-4">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h4 class="font-medium">${opp.title}</h4>
                                                    <p class="text-sm text-gray-600">Rep: ${opp.salesRep}</p>
                                                    <p class="text-sm text-gray-500">Close: ${opp.expectedClose || 'Not set'}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="font-semibold">$${(opp.value || 0).toLocaleString()}</p>
                                                    ${stage ? `
                                                        <span class="inline-block mt-1 px-2 py-1 text-xs rounded-full text-white ${stage.color}">
                                                            ${stage.name}
                                                        </span>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;

                    case 'activities':
                        return `
                            <div>
                                <div class="flex justify-between items-center mb-3">
                                    <button onclick="app.toggleShowCompletedModal()"
                                            class="text-sm text-blue-600 hover:text-blue-800">
                                        ${this.state.showCompletedActivities ? 'Hide' : 'Show'} Completed
                                    </button>
                                    <button onclick="app.scheduleActivityForCustomer('${customer.id}'); app.closeModal();"
                                            class="text-blue-600 hover:text-blue-800 text-sm">
                                        ${this.icon('Plus', 16, 'inline')} Add Activity
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    ${activities
                                        .filter(a => this.state.showCompletedActivities || !a.completed)
                                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                                        .map(activity => `
                                            <div class="border rounded-lg p-3 ${activity.completed ? 'bg-gray-50 cursor-pointer hover:bg-gray-100' : ''}"
                                                 ${activity.completed ? `onclick="app.viewActivity('${activity.id}')"` : ''}>
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <p class="font-medium text-sm">${activity.subject}</p>
                                                        <p class="text-xs text-gray-600">${activity.date} at ${activity.time}</p>
                                                        ${activity.notes ? `
                                                            <p class="text-xs text-gray-500 mt-1">${activity.notes}</p>
                                                        ` : ''}
                                                        ${activity.audioRecording ? `
                                                            <div class="mt-2">
                                                                <audio controls class="w-full max-w-xs h-8" onclick="event.stopPropagation()">
                                                                    <source src="${activity.audioRecording.url || activity.audioRecording.localData}" 
                                                                            type="${activity.audioRecording.mimeType || 'audio/webm'}">
                                                                </audio>
                                                                <p class="text-xs text-gray-400">
                                                                    Audio (${Math.floor(activity.audioRecording.duration / 60)}:${(activity.audioRecording.duration % 60).toString().padStart(2, '0')})
                                                                </p>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                    <span class="text-xs px-2 py-1 rounded-full ${
                                                        activity.completed 
                                                            ? 'bg-green-100 text-green-800' 
                                                            : 'bg-yellow-100 text-yellow-800'
                                                    }">
                                                        ${activity.completed ? 'Completed' : 'Pending'}
                                                    </span>
                                                </div>
                                            </div>
                                        `).join('')}
                                </div>
                            </div>
                        `;

                    case 'quotes':
                        return `
                            <div class="space-y-3">
                                ${quotes.length === 0 ? `
                                    <p class="text-gray-400">No quotes yet</p>
                                ` : quotes.map(quote => `
                                    <div class="border rounded-lg p-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h4 class="font-medium">${quote.quoteName}</h4>
                                                <p class="text-sm text-gray-500">${quote.quoteNumber}</p>
                                                <p class="text-xs text-gray-500 mt-1">
                                                    Created: ${new Date(quote.createdAt).toLocaleDateString()}
                                                </p>
                                            </div>
                                            <span class="px-2 py-1 text-xs rounded-full ${
                                                quote.status === 'sent' ? 'bg-blue-100 text-blue-800' :
                                                quote.status === 'accepted' ? 'bg-green-100 text-green-800' :
                                                'bg-gray-100 text-gray-800'
                                            }">
                                                ${quote.status}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;

                    case 'details':
                        return `
                            <div class="space-y-6">
                                ${customer.companyBackground ? `
                                    <div>
                                        <h4 class="font-medium mb-2">Company Background</h4>
                                        <p class="text-sm text-gray-600">${customer.companyBackground}</p>
                                    </div>
                                ` : ''}
                                
                                ${customer.deliveryPreferences ? `
                                    <div>
                                        <h4 class="font-medium mb-2">Delivery Preferences</h4>
                                        <p class="text-sm text-gray-600">${customer.deliveryPreferences}</p>
                                    </div>
                                ` : ''}
                                
                                ${customer.paymentTerms ? `
                                    <div>
                                        <h4 class="font-medium mb-2">Payment Terms</h4>
                                        <p class="text-sm text-gray-600">${customer.paymentTerms}</p>
                                    </div>
                                ` : ''}
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${customer.website ? `
                                        <div>
                                            <h4 class="font-medium mb-2">Website</h4>
                                            <a href="${customer.website}" target="_blank" 
                                               class="text-sm text-blue-600 hover:underline flex items-center space-x-1">
                                                ${this.icon('Globe', 16)}
                                                <span>Visit Website</span>
                                            </a>
                                        </div>
                                    ` : ''}
                                    
                                    ${customer.linkedIn ? `
                                        <div>
                                            <h4 class="font-medium mb-2">LinkedIn</h4>
                                            <a href="${customer.linkedIn}" target="_blank" 
                                               class="text-sm text-blue-600 hover:underline flex items-center space-x-1">
                                                ${this.icon('LinkedIn', 16)}
                                                <span>View LinkedIn</span>
                                            </a>
                                        </div>
                                    ` : ''}
                                </div>

                                ${customer.attachments && customer.attachments.length > 0 ? `
                                    <div>
                                        <h4 class="font-medium mb-2">Attachments</h4>
                                        <div class="space-y-2">
                                            ${customer.attachments.map(attachment => `
                                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                    <a href="${attachment.url}" target="_blank" 
                                                       class="text-sm text-blue-600 hover:underline flex items-center space-x-2">
                                                        ${this.icon('Paperclip', 16)}
                                                        <span>${attachment.name}</span>
                                                    </a>
                                                    <span class="text-xs text-gray-500">
                                                        ${new Date(attachment.uploadedAt).toLocaleDateString()}
                                                    </span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                }
            }

            renderOpportunityModal() {
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeModal()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"
                             onclick="event.stopPropagation()">
                            <h3 class="text-lg font-semibold mb-4">Add New Opportunity</h3>
                            
                            <form onsubmit="event.preventDefault(); app.handleModalSubmit()">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                                        <select required
                                                value="${this.state.formData.customerId || ''}"
                                                onchange="app.updateFormField('customerId', this.value)"
                                                class="w-full p-2 border rounded-lg">
                                            <option value="">Select Customer</option>
                                            ${this.state.customers.map(customer => `
                                                <option value="${customer.id}" ${this.state.formData.customerId === customer.id ? 'selected' : ''}>
                                                    ${customer.name}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Opportunity Title *</label>
                                        <input type="text" required
                                               value="${this.state.formData.title || ''}"
                                               oninput="app.updateFormField('title', this.value)"
                                               class="w-full p-2 border rounded-lg">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Value ($)</label>
                                        <input type="number" min="0" step="100"
                                               value="${this.state.formData.value || ''}"
                                               oninput="app.updateFormField('value', parseFloat(this.value))"
                                               class="w-full p-2 border rounded-lg">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Expected Close Date</label>
                                        <input type="date"
                                               value="${this.state.formData.expectedClose || ''}"
                                               onchange="app.updateFormField('expectedClose', this.value)"
                                               class="w-full p-2 border rounded-lg">
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="app.closeModal()"
                                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                        Cancel
                                    </button>
                                    <button type="submit"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Add Opportunity
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }

            renderQuoteModal() {
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeModal()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"
                             onclick="event.stopPropagation()">
                            <h3 class="text-lg font-semibold mb-4">Create New Quote</h3>
                            
                            <form onsubmit="event.preventDefault(); app.handleModalSubmit()">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Quote Name *</label>
                                        <input type="text" required
                                               value="${this.state.formData.quoteName || ''}"
                                               oninput="app.updateFormField('quoteName', this.value)"
                                               placeholder="e.g., Q1 2025 Steel Tubing Order"
                                               class="w-full p-2 border rounded-lg">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                                        <select required
                                                value="${this.state.formData.customerId || ''}"
                                                onchange="app.updateFormField('customerId', this.value)"
                                                class="w-full p-2 border rounded-lg">
                                            <option value="">Select Customer</option>
                                            ${this.state.customers.map(customer => `
                                                <option value="${customer.id}" ${this.state.formData.customerId === customer.id ? 'selected' : ''}>
                                                    ${customer.name}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="app.closeModal()"
                                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                        Cancel
                                    </button>
                                    <button type="submit"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Create Quote
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }

            renderActivityModal() {
                const isEditing = !!this.state.editingActivity;
                const title = isEditing ? 'Edit Activity' : 'Schedule Activity';
                
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeModal()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"
                             onclick="event.stopPropagation()">
                            <h3 class="text-lg font-semibold mb-4">${title}</h3>
                            
                            <form onsubmit="event.preventDefault(); app.handleModalSubmit()">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                                        <select required
                                                value="${this.state.formData.customerId || ''}"
                                                onchange="app.updateFormField('customerId', this.value)"
                                                class="w-full p-2 border rounded-lg">
                                            <option value="">Select Customer</option>
                                            ${this.state.customers.map(customer => `
                                                <option value="${customer.id}" ${this.state.formData.customerId === customer.id ? 'selected' : ''}>
                                                    ${customer.name}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                                        <select required
                                                value="${this.state.formData.type || 'call'}"
                                                onchange="app.updateFormField('type', this.value)"
                                                class="w-full p-2 border rounded-lg">
                                            <option value="call">Call</option>
                                            <option value="email">Email</option>
                                            <option value="meeting">Meeting</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Subject *</label>
                                        <input type="text" required
                                               value="${this.state.formData.subject || ''}"
                                               oninput="app.updateFormField('subject', this.value)"
                                               class="w-full p-2 border rounded-lg">
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                                            <input type="date" required
                                                   value="${this.state.formData.date || ''}"
                                                   onchange="app.updateFormField('date', this.value)"
                                                   class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Time *</label>
                                            <input type="text" required
                                                   value="${this.state.formData.time || '10:00 AM'}"
                                                   oninput="app.updateFormField('time', this.value)"
                                                   placeholder="10:00 AM"
                                                   class="w-full p-2 border rounded-lg">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                        <textarea rows="3"
                                                  value="${this.state.formData.notes || ''}"
                                                  oninput="app.updateFormField('notes', this.value)"
                                                  class="w-full p-2 border rounded-lg"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Pipeline Stage</label>
                                        <select value="${this.state.formData.pipelineStage || ''}"
                                                onchange="app.updateFormField('pipelineStage', this.value)"
                                                class="w-full p-2 border rounded-lg">
                                            ${this.customerStages.map(stage => `
                                                <option value="${stage.id}" ${this.state.formData.pipelineStage === stage.id ? 'selected' : ''}>
                                                    ${stage.name}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    ${!isEditing ? `
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Audio Note</label>
                                            <div class="flex items-center space-x-2">
                                                ${!this.state.isRecording ? `
                                                    <button type="button"
                                                            onclick="app.startRecording()"
                                                            class="flex items-center space-x-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                                        ${this.icon('Mic', 20)}
                                                        <span>Record</span>
                                                    </button>
                                                ` : `
                                                    <button type="button"
                                                            onclick="app.stopRecording()"
                                                            class="flex items-center space-x-2 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 recording">
                                                        ${this.icon('Square', 20)}
                                                        <span>Stop</span>
                                                    </button>
                                                    <span id="recording-time" class="text-red-600 font-mono">0:00</span>
                                                `}
                                                ${this.state.formData.audioRecording ? `
                                                    <span class="text-sm text-green-600">✓ Audio recorded (${this.state.formData.audioRecording.duration}s)</span>
                                                ` : ''}
                                            </div>
                                        </div>

                                        ${this.state.googleCalendarConnected ? `
                                            <div>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox"
                                                           ${this.state.formData.addToCalendar ? 'checked' : ''}
                                                           onchange="app.updateFormField('addToCalendar', this.checked)"
                                                           class="rounded">
                                                    <span class="text-sm">Add to Google Calendar</span>
                                                </label>
                                            </div>
                                        ` : ''}
                                    ` : ''}
                                </div>
                                
                                <div class="flex justify-end space-x-3 mt-6">
                                    <button type="button" onclick="app.closeModal()"
                                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                        Cancel
                                    </button>
                                    <button type="submit"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        ${isEditing ? 'Update' : 'Schedule'} Activity
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }

            renderViewActivityModal() {
                if (!this.state.viewingActivity) return '';
                
                const activity = this.state.viewingActivity;
                const customer = this.state.customers.find(c => c.id === activity.customerId);
                
                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         onclick="app.closeModal()">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"
                             onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Activity Details</h3>
                                <button onclick="app.closeModal()" class="text-gray-500 hover:text-gray-700">
                                    ${this.icon('X', 24)}
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <p class="text-sm text-gray-500">Subject</p>
                                    <p class="font-medium">${activity.subject}</p>
                                </div>
                                
                                <div>
                                    <p class="text-sm text-gray-500">Customer</p>
                                    <p class="font-medium">${customer?.name || 'Unknown'}</p>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Type</p>
                                        <p class="font-medium capitalize">${activity.type}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Status</p>
                                        <span class="inline-block px-2 py-1 text-xs rounded-full ${
                                            activity.completed 
                                                ? 'bg-green-100 text-green-800' 
                                                : 'bg-yellow-100 text-yellow-800'
                                        }">
                                            ${activity.completed ? 'Completed' : 'Pending'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div>
                                    <p class="text-sm text-gray-500">Scheduled</p>
                                    <p class="font-medium">${activity.date} at ${activity.time}</p>
                                </div>
                                
                                ${activity.completedDate ? `
                                    <div>
                                        <p class="text-sm text-gray-500">Completed</p>
                                        <p class="font-medium">${new Date(activity.completedDate).toLocaleString()}</p>
                                    </div>
                                ` : ''}
                                
                                ${activity.notes ? `
                                    <div>
                                        <p class="text-sm text-gray-500">Notes</p>
                                        <p class="text-sm">${activity.notes}</p>
                                    </div>
                                ` : ''}
                                
                                ${activity.audioRecording ? `
                                    <div>
                                        <p class="text-sm text-gray-500 mb-2">Audio Recording</p>
                                        <audio controls class="w-full" preload="metadata">
                                            <source src="${activity.audioRecording.url || activity.audioRecording.localData}" 
                                                    type="${activity.audioRecording.mimeType || 'audio/webm'}">
                                            Your browser does not support the audio element.
                                        </audio>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Recorded: ${new Date(activity.audioRecording.recordedAt).toLocaleString()}
                                            <br>Duration: ${Math.floor(activity.audioRecording.duration / 60)}:${(activity.audioRecording.duration % 60).toString().padStart(2, '0')}
                                        </p>
                                    </div>
                                ` : ''}
                                
                                ${activity.googleCalendarId ? `
                                    <div>
                                        <p class="text-sm text-gray-500">Google Calendar</p>
                                        <a href="${activity.googleCalendarLink}" target="_blank"
                                           class="text-sm text-blue-600 hover:underline">
                                            ${this.icon('Calendar', 16, 'inline')} View in Calendar
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button onclick="app.closeModal()"
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                    Close
                                </button>
                                ${!activity.completed ? `
                                    <button onclick="app.editActivity('${activity.id}'); app.closeModal();"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Edit
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize the app
        const app = new MajorMetalsCRM();
        window.app = app;
    </script>
</body>
</html>